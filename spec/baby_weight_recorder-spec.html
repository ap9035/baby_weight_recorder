<!DOCTYPE html>
<html>
<head>
<title>baby_weitht_recorder-speec.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h1 id="%E5%AC%B0%E5%85%92%E9%AB%94%E9%87%8D%E7%B4%80%E9%8C%84%E7%B3%BB%E7%B5%B1">å¬°å…’é«”é‡ç´€éŒ„ç³»çµ±</h1>
<blockquote>
<p>æŠ€è¡“è¦æ ¼æ›¸ï¼ˆGCP / Cloud Run / API Gateway / Firestoreï¼‰</p>
</blockquote>
<hr>
<h2 id="%E7%9B%AE%E9%8C%84">ç›®éŒ„</h2>
<ul>
<li><a href="#%E5%AC%B0%E5%85%92%E9%AB%94%E9%87%8D%E7%B4%80%E9%8C%84%E7%B3%BB%E7%B5%B1">å¬°å…’é«”é‡ç´€éŒ„ç³»çµ±</a>
<ul>
<li><a href="#%E7%9B%AE%E9%8C%84">ç›®éŒ„</a></li>
<li><a href="#1-%E6%96%87%E4%BB%B6%E8%B3%87%E8%A8%8A">1. æ–‡ä»¶è³‡è¨Š</a></li>
<li><a href="#2-%E7%B3%BB%E7%B5%B1%E7%9B%AE%E6%A8%99%E8%88%87%E9%9C%80%E6%B1%82">2. ç³»çµ±ç›®æ¨™èˆ‡éœ€æ±‚</a>
<ul>
<li><a href="#21-%E7%B3%BB%E7%B5%B1%E7%9B%AE%E6%A8%99">2.1 ç³»çµ±ç›®æ¨™</a></li>
<li><a href="#22-%E5%8A%9F%E8%83%BD%E6%80%A7%E9%9C%80%E6%B1%82">2.2 åŠŸèƒ½æ€§éœ€æ±‚</a></li>
<li><a href="#23-%E9%9D%9E%E5%8A%9F%E8%83%BD%E6%80%A7%E9%9C%80%E6%B1%82">2.3 éåŠŸèƒ½æ€§éœ€æ±‚</a></li>
</ul>
</li>
<li><a href="#3-%E6%95%B4%E9%AB%94%E7%B3%BB%E7%B5%B1%E6%9E%B6%E6%A7%8B">3. æ•´é«”ç³»çµ±æ¶æ§‹</a>
<ul>
<li><a href="#31-%E6%9E%B6%E6%A7%8B%E6%A6%82%E8%A6%BD">3.1 æ¶æ§‹æ¦‚è¦½</a></li>
<li><a href="#32-%E8%A8%AD%E8%A8%88%E5%8E%9F%E5%89%87">3.2 è¨­è¨ˆåŸå‰‡</a></li>
</ul>
</li>
<li><a href="#4-gcp-%E5%85%83%E4%BB%B6%E8%AA%AA%E6%98%8E">4. GCP å…ƒä»¶èªªæ˜</a>
<ul>
<li><a href="#41-auth-service%E8%87%AA%E5%BB%BA%E6%9C%80%E5%B0%8F-oidc-provider">4.1 Auth Serviceï¼ˆè‡ªå»ºæœ€å° OIDC Providerï¼‰</a>
<ul>
<li><a href="#411-auth-service-%E8%81%B7%E8%B2%AC">4.1.1 Auth Service è·è²¬</a></li>
<li><a href="#412-auth-service-endpoints">4.1.2 Auth Service Endpoints</a></li>
<li><a href="#413-jwt-token-%E8%A6%8F%E6%A0%BC">4.1.3 JWT Token è¦æ ¼</a></li>
<li><a href="#414-jwks-%E8%A6%8F%E6%A0%BC">4.1.4 JWKS è¦æ ¼</a></li>
<li><a href="#415-%E7%99%BB%E5%85%A5%E6%96%B9%E5%BC%8F">4.1.5 ç™»å…¥æ–¹å¼</a></li>
</ul>
</li>
<li><a href="#42-api-gateway">4.2 API Gateway</a></li>
<li><a href="#43-cloud-run--weight-api-service">4.3 Cloud Run â€“ Weight API Service</a></li>
<li><a href="#44-firestorenative-mode">4.4 Firestoreï¼ˆNative Modeï¼‰</a></li>
</ul>
</li>
<li><a href="#5-%E8%AA%8D%E8%AD%89%E8%88%87%E6%8E%88%E6%AC%8A%E8%A8%AD%E8%A8%88">5. èªè­‰èˆ‡æˆæ¬Šè¨­è¨ˆ</a>
<ul>
<li><a href="#51-%E8%AA%8D%E8%AD%89%E6%B5%81%E7%A8%8Bauthn">5.1 èªè­‰æµç¨‹ï¼ˆAuthNï¼‰</a></li>
<li><a href="#52-%E6%8E%88%E6%AC%8A%E6%B5%81%E7%A8%8Bauthz">5.2 æˆæ¬Šæµç¨‹ï¼ˆAuthZï¼‰</a></li>
</ul>
</li>
<li><a href="#6-firestore-%E8%B3%87%E6%96%99%E6%A8%A1%E5%9E%8B%E8%A8%AD%E8%A8%88">6. Firestore è³‡æ–™æ¨¡å‹è¨­è¨ˆ</a>
<ul>
<li><a href="#61-%E5%85%A7%E9%83%A8%E4%BD%BF%E7%94%A8%E8%80%85-id-%E6%A0%BC%E5%BC%8F">6.1 å…§éƒ¨ä½¿ç”¨è€… ID æ ¼å¼</a></li>
<li><a href="#62-collections-%E7%B5%90%E6%A7%8B">6.2 Collections çµæ§‹</a></li>
<li><a href="#63-identity_links-%E6%9F%A5%E8%A9%A2%E7%B4%A2%E5%BC%95">6.3 identity_links æŸ¥è©¢ç´¢å¼•</a></li>
<li><a href="#64-%E8%BA%AB%E4%BB%BD%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B">6.4 èº«ä»½è§£ææµç¨‹</a></li>
<li><a href="#65-%E6%AC%8A%E9%99%90%E9%82%8F%E8%BC%AF">6.5 æ¬Šé™é‚è¼¯</a></li>
</ul>
</li>
<li><a href="#7-api-%E8%A6%8F%E6%A0%BCv1">7. API è¦æ ¼ï¼ˆv1ï¼‰</a>
<ul>
<li><a href="#71-%E5%BB%BA%E7%AB%8B%E5%AC%B0%E5%85%92">7.1 å»ºç«‹å¬°å…’</a></li>
<li><a href="#72-%E6%96%B0%E5%A2%9E%E9%AB%94%E9%87%8D%E7%B4%80%E9%8C%84">7.2 æ–°å¢é«”é‡ç´€éŒ„</a></li>
<li><a href="#73-%E6%9F%A5%E8%A9%A2%E9%AB%94%E9%87%8D%E7%B4%80%E9%8C%84">7.3 æŸ¥è©¢é«”é‡ç´€éŒ„</a></li>
</ul>
</li>
<li><a href="#8-%E9%8C%AF%E8%AA%A4%E8%99%95%E7%90%86">8. éŒ¯èª¤è™•ç†</a></li>
<li><a href="#9-%E9%83%A8%E7%BD%B2%E8%88%87%E7%B6%AD%E9%81%8B%E5%BB%BA%E8%AD%B0">9. éƒ¨ç½²èˆ‡ç¶­é‹å»ºè­°</a>
<ul>
<li><a href="#91-%E5%9F%BA%E7%A4%8E%E8%A8%AD%E6%96%BD%E5%8D%B3%E7%A8%8B%E5%BC%8F%E7%A2%BCiac">9.1 åŸºç¤è¨­æ–½å³ç¨‹å¼ç¢¼ï¼ˆIaCï¼‰</a>
<ul>
<li><a href="#911-terraform-%E7%AE%A1%E7%90%86%E7%9A%84-gcp-%E8%B3%87%E6%BA%90">9.1.1 Terraform ç®¡ç†çš„ GCP è³‡æº</a></li>
<li><a href="#912-terraform-%E5%B0%88%E6%A1%88%E7%B5%90%E6%A7%8B">9.1.2 Terraform å°ˆæ¡ˆçµæ§‹</a></li>
<li><a href="#913-%E7%92%B0%E5%A2%83%E5%88%86%E9%9B%A2%E7%AD%96%E7%95%A5">9.1.3 ç’°å¢ƒåˆ†é›¢ç­–ç•¥</a></li>
<li><a href="#914-terraform-state-%E7%AE%A1%E7%90%86">9.1.4 Terraform State ç®¡ç†</a></li>
<li><a href="#915-%E6%A9%9F%E6%95%8F%E8%B3%87%E6%96%99%E8%99%95%E7%90%86">9.1.5 æ©Ÿæ•è³‡æ–™è™•ç†</a></li>
<li><a href="#916-%E9%83%A8%E7%BD%B2%E6%B5%81%E7%A8%8B">9.1.6 éƒ¨ç½²æµç¨‹</a></li>
<li><a href="#917-%E9%97%9C%E9%8D%B5-terraform-%E8%A8%AD%E5%AE%9A%E7%AF%84%E4%BE%8B">9.1.7 é—œéµ Terraform è¨­å®šç¯„ä¾‹</a></li>
</ul>
</li>
<li><a href="#92-cloud-run-%E8%A8%AD%E5%AE%9A">9.2 Cloud Run è¨­å®š</a></li>
<li><a href="#93-firestore-%E8%A8%AD%E5%AE%9A">9.3 Firestore è¨­å®š</a></li>
<li><a href="#94-logging-%E8%A8%AD%E5%AE%9A">9.4 Logging è¨­å®š</a></li>
<li><a href="#95-secrets-%E7%AE%A1%E7%90%86">9.5 Secrets ç®¡ç†</a></li>
<li><a href="#96-github-actions-cicd">9.6 GitHub Actions CI/CD</a>
<ul>
<li><a href="#961-workflow-%E7%B8%BD%E8%A6%BD">9.6.1 Workflow ç¸½è¦½</a></li>
<li><a href="#962-github-actions-%E6%AA%94%E6%A1%88%E7%B5%90%E6%A7%8B">9.6.2 GitHub Actions æª”æ¡ˆçµæ§‹</a></li>
<li><a href="#963-gcp-%E8%AA%8D%E8%AD%89%E8%A8%AD%E5%AE%9Aworkload-identity-federation">9.6.3 GCP èªè­‰è¨­å®šï¼ˆWorkload Identity Federationï¼‰</a></li>
<li><a href="#964-ci-workflowciyml">9.6.4 CI Workflowï¼ˆci.ymlï¼‰</a></li>
<li><a href="#965-deploy-dev-workflowdeploy-devyml">9.6.5 Deploy Dev Workflowï¼ˆdeploy-dev.ymlï¼‰</a></li>
<li><a href="#966-deploy-prod-workflowdeploy-prodyml">9.6.6 Deploy Prod Workflowï¼ˆdeploy-prod.ymlï¼‰</a></li>
<li><a href="#967-terraform-plan-for-prterraform-planyml">9.6.7 Terraform Plan for PRï¼ˆterraform-plan.ymlï¼‰</a></li>
<li><a href="#968-%E9%83%A8%E7%BD%B2%E7%92%B0%E5%A2%83%E4%BF%9D%E8%AD%B7">9.6.8 éƒ¨ç½²ç’°å¢ƒä¿è­·</a></li>
<li><a href="#969-%E5%AE%8C%E6%95%B4%E9%83%A8%E7%BD%B2%E6%B5%81%E7%A8%8B">9.6.9 å®Œæ•´éƒ¨ç½²æµç¨‹</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#10-%E6%9C%AC%E5%9C%B0%E9%96%8B%E7%99%BC%E8%88%87%E6%B8%AC%E8%A9%A6%E7%AD%96%E7%95%A5">10. æœ¬åœ°é–‹ç™¼èˆ‡æ¸¬è©¦ç­–ç•¥</a>
<ul>
<li><a href="#101-%E6%9C%AC%E5%9C%B0%E9%96%8B%E7%99%BC%E7%9B%AE%E6%A8%99">10.1 æœ¬åœ°é–‹ç™¼ç›®æ¨™</a></li>
<li><a href="#102-firestore-emulator-%E9%96%8B%E7%99%BC%E6%A8%A1%E5%BC%8F%E4%B8%BB%E8%A6%81%E6%8E%A8%E8%96%A6">10.2 Firestore Emulator é–‹ç™¼æ¨¡å¼ï¼ˆä¸»è¦æ¨è–¦ï¼‰</a>
<ul>
<li><a href="#1021-%E5%B7%A5%E5%85%B7%E9%9C%80%E6%B1%82">10.2.1 å·¥å…·éœ€æ±‚</a></li>
<li><a href="#1022-%E5%95%9F%E5%8B%95-emulator">10.2.2 å•Ÿå‹• Emulator</a></li>
<li><a href="#1023-api-%E6%9C%8D%E5%8B%99%E9%80%A3%E7%B7%9A-emulator">10.2.3 API æœå‹™é€£ç·š Emulator</a></li>
</ul>
</li>
<li><a href="#103-in-memory-repository-%E6%A8%A1%E5%BC%8F%E6%B8%AC%E8%A9%A6%E7%94%A8">10.3 In-Memory Repository æ¨¡å¼ï¼ˆæ¸¬è©¦ç”¨ï¼‰</a></li>
<li><a href="#104-%E6%9C%AC%E5%9C%B0%E8%AA%8D%E8%AD%89auth%E7%AD%96%E7%95%A5">10.4 æœ¬åœ°èªè­‰ï¼ˆAuthï¼‰ç­–ç•¥</a>
<ul>
<li><a href="#1041-dev-auth-%E6%A8%A1%E5%BC%8F%E9%A0%90%E8%A8%AD">10.4.1 Dev Auth æ¨¡å¼ï¼ˆé è¨­ï¼‰</a></li>
<li><a href="#1042-%E6%9C%AC%E5%9C%B0-auth-service%E9%80%B2%E9%9A%8E">10.4.2 æœ¬åœ° Auth Serviceï¼ˆé€²éšï¼‰</a></li>
</ul>
</li>
<li><a href="#105-auth-%E6%A8%A1%E5%BC%8F%E5%88%87%E6%8F%9B%E8%A8%AD%E8%A8%88">10.5 Auth æ¨¡å¼åˆ‡æ›è¨­è¨ˆ</a></li>
<li><a href="#106-%E6%9C%AC%E5%9C%B0-api-%E5%95%9F%E5%8B%95%E6%A8%99%E6%BA%96%E7%92%B0%E5%A2%83%E8%AE%8A%E6%95%B8">10.6 æœ¬åœ° API å•Ÿå‹•æ¨™æº–ç’°å¢ƒè®Šæ•¸</a></li>
<li><a href="#107-%E6%9C%AC%E5%9C%B0%E8%B3%87%E6%96%99%E5%88%9D%E5%A7%8B%E5%8C%96%E5%BB%BA%E8%AD%B0">10.7 æœ¬åœ°è³‡æ–™åˆå§‹åŒ–å»ºè­°</a></li>
<li><a href="#108-%E6%9C%AC%E5%9C%B0%E6%B8%AC%E8%A9%A6%E6%B5%81%E7%A8%8B%E7%AF%84%E4%BE%8B">10.8 æœ¬åœ°æ¸¬è©¦æµç¨‹ï¼ˆç¯„ä¾‹ï¼‰</a></li>
<li><a href="#109-%E6%B8%AC%E8%A9%A6%E7%AD%96%E7%95%A5%E7%B8%BD%E8%A6%BD">10.9 æ¸¬è©¦ç­–ç•¥ç¸½è¦½</a>
<ul>
<li><a href="#1091-%E6%B8%AC%E8%A9%A6%E5%B1%A4%E6%AC%A1%E8%88%87-authgateway-%E9%85%8D%E7%BD%AE">10.9.1 æ¸¬è©¦å±¤æ¬¡èˆ‡ Auth/Gateway é…ç½®</a></li>
<li><a href="#1092-%E7%B9%9E%E9%81%8E-auth-%E7%9A%84%E5%BF%AB%E9%80%9F%E6%B8%AC%E8%A9%A6">10.9.2 ç¹é Auth çš„å¿«é€Ÿæ¸¬è©¦</a></li>
<li><a href="#1093-%E4%B8%8D%E7%B9%9E%E9%81%8E-auth-%E7%9A%84%E6%95%B4%E5%90%88%E6%B8%AC%E8%A9%A6">10.9.3 ä¸ç¹é Auth çš„æ•´åˆæ¸¬è©¦</a></li>
<li><a href="#1094-api-gateway-%E6%B8%AC%E8%A9%A6%E7%AD%96%E7%95%A5">10.9.4 API Gateway æ¸¬è©¦ç­–ç•¥</a></li>
<li><a href="#1095-%E6%9C%AC%E5%9C%B0%E6%9B%BF%E4%BB%A3-gateway%E5%8F%AF%E9%81%B8">10.9.5 æœ¬åœ°æ›¿ä»£ Gatewayï¼ˆå¯é¸ï¼‰</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#11-idp-%E5%8F%AF%E6%9B%BF%E6%8F%9B%E8%A8%AD%E8%A8%88">11. IdP å¯æ›¿æ›è¨­è¨ˆ</a>
<ul>
<li><a href="#111-%E6%A0%B8%E5%BF%83%E7%9B%B8%E5%AE%B9%E6%80%A7%E8%A8%AD%E8%A8%88">11.1 æ ¸å¿ƒç›¸å®¹æ€§è¨­è¨ˆ</a></li>
<li><a href="#112-%E5%8D%87%E7%B4%9A%E8%B7%AF%E7%B7%9A-1%E8%87%AA%E5%BB%BA-auth--keycloak">11.2 å‡ç´šè·¯ç·š 1ï¼šè‡ªå»º Auth â†’ Keycloak</a></li>
<li><a href="#113-%E5%8D%87%E7%B4%9A%E8%B7%AF%E7%B7%9A-2%E8%87%AA%E5%BB%BA-auth--firebase-auth">11.3 å‡ç´šè·¯ç·š 2ï¼šè‡ªå»º Auth â†’ Firebase Auth</a></li>
<li><a href="#114-%E8%BA%AB%E4%BB%BD%E7%B6%81%E5%AE%9A%E7%AD%96%E7%95%A5%E5%A4%9A-idp-%E5%85%B1%E5%AD%98">11.4 èº«ä»½ç¶å®šç­–ç•¥ï¼ˆå¤š IdP å…±å­˜ï¼‰</a></li>
<li><a href="#115-%E5%8D%87%E7%B4%9A%E6%99%82%E7%9A%84%E5%85%83%E4%BB%B6%E5%BD%B1%E9%9F%BF">11.5 å‡ç´šæ™‚çš„å…ƒä»¶å½±éŸ¿</a></li>
</ul>
</li>
<li><a href="#12-%E6%9C%AA%E4%BE%86%E6%93%B4%E5%85%85%E6%96%B9%E5%90%91">12. æœªä¾†æ“´å……æ–¹å‘</a></li>
<li><a href="#13-%E9%99%84%E9%8C%84">13. é™„éŒ„</a></li>
</ul>
</li>
</ul>
<hr>
<h2 id="1-%E6%96%87%E4%BB%B6%E8%B3%87%E8%A8%8A">1. æ–‡ä»¶è³‡è¨Š</h2>
<ul>
<li>æ–‡ä»¶ç‰ˆæœ¬ï¼šv1.4</li>
<li>æœ€å¾Œæ›´æ–°ï¼š2026-01-11</li>
<li>è®Šæ›´æ‘˜è¦ï¼š
<ul>
<li>v1.4ï¼šæŠ€è¡“æ£§æ”¹ç‚º Python 3.12 + FastAPI</li>
<li>v1.3ï¼šæ–°å¢ GitHub Actions CI/CD éƒ¨ç½²èªªæ˜</li>
<li>v1.3ï¼šæ–°å¢å®Œæ•´æ¸¬è©¦ç­–ç•¥ï¼ˆå« API Gateway æ¸¬è©¦èªªæ˜ï¼‰</li>
<li>v1.2ï¼šæ–°å¢ Terraform åŸºç¤å»ºè¨­ç®¡ç†ç« ç¯€</li>
<li>v1.1ï¼šæ”¹ç‚ºè‡ªå»ºæœ€å° OIDC Auth Service æ–¹æ¡ˆ</li>
<li>v1.1ï¼šæ–°å¢ IdP å¯æ›¿æ›è¨­è¨ˆç« ç¯€</li>
<li>v1.1ï¼šæ–°å¢ identity_links è³‡æ–™æ¨¡å‹</li>
<li>v1.1ï¼šæ¡ç”¨ ULID ä½œç‚º internalUserId æ ¼å¼</li>
</ul>
</li>
<li>ç›®æ¨™è®€è€…ï¼š
<ul>
<li>Backend å·¥ç¨‹å¸«</li>
<li>Mobile / Web App å·¥ç¨‹å¸«</li>
<li>DevOps / Cloud ç®¡ç†è€…</li>
</ul>
</li>
</ul>
<hr>
<h2 id="2-%E7%B3%BB%E7%B5%B1%E7%9B%AE%E6%A8%99%E8%88%87%E9%9C%80%E6%B1%82">2. ç³»çµ±ç›®æ¨™èˆ‡éœ€æ±‚</h2>
<h3 id="21-%E7%B3%BB%E7%B5%B1%E7%9B%AE%E6%A8%99">2.1 ç³»çµ±ç›®æ¨™</h3>
<p>å»ºç«‹ä¸€å€‹å¯åœ¨ <strong>GCP Cloud Run</strong> ä¸Šé‹è¡Œçš„å¾Œç«¯ç³»çµ±ï¼Œç”¨æ–¼ï¼š</p>
<ul>
<li>æ¥æ”¶ Client Request ä¸¦è¨˜éŒ„å¬°å…’é«”é‡</li>
<li>æ”¯æ´å¤šä½¿ç”¨è€…ã€å¤šå¬°å…’</li>
<li>å…·å‚™å®‰å…¨çš„ Client èªè­‰èˆ‡å­˜å–æ§ç®¡</li>
<li>ä½¿ç”¨ä½ç¶­é‹æˆæœ¬çš„é›²ç«¯æœå‹™</li>
</ul>
<h3 id="22-%E5%8A%9F%E8%83%BD%E6%80%A7%E9%9C%80%E6%B1%82">2.2 åŠŸèƒ½æ€§éœ€æ±‚</h3>
<ul>
<li>ä½¿ç”¨è€…è¨»å†Š / ç™»å…¥</li>
<li>å»ºç«‹å¬°å…’è³‡æ–™</li>
<li>è¨˜éŒ„å¬°å…’é«”é‡ï¼ˆæ™‚é–“ã€é‡é‡ã€å‚™è¨»ï¼‰</li>
<li>æŸ¥è©¢é«”é‡æ­·å²ç´€éŒ„</li>
<li>æ”¯æ´å¤šä½ç…§é¡§è€…å…±åŒç®¡ç†åŒä¸€å¬°å…’</li>
</ul>
<h3 id="23-%E9%9D%9E%E5%8A%9F%E8%83%BD%E6%80%A7%E9%9C%80%E6%B1%82">2.3 éåŠŸèƒ½æ€§éœ€æ±‚</h3>
<ul>
<li>HTTPS only</li>
<li>Stateless backend</li>
<li>å¯æ°´å¹³æ“´å……</li>
<li>æˆæœ¬å¯æ§ï¼ˆé©åˆå€‹äºº / å°å®¶åº­ä½¿ç”¨ï¼‰</li>
<li>API versioningï¼ˆv1ï¼‰</li>
</ul>
<hr>
<h2 id="3-%E6%95%B4%E9%AB%94%E7%B3%BB%E7%B5%B1%E6%9E%B6%E6%A7%8B">3. æ•´é«”ç³»çµ±æ¶æ§‹</h2>
<h3 id="31-%E6%9E%B6%E6%A7%8B%E6%A6%82%E8%A6%BD">3.1 æ¶æ§‹æ¦‚è¦½</h3>
<pre><code class="language-mermaid"><div class="mermaid">flowchart LR
    Client[Mobile / Web Client]
    Auth[Auth Service
è‡ªå»º OIDC Provider]
    GW[API Gateway]
    CR[Cloud Run
Weight API Service]
    DB[(Firestore
Native Mode)]

    Client -->|Login| Auth
    Auth -->|JWT| Client
    Client -->|HTTPS + Bearer JWT| GW
    GW -->|Verify via JWKS| Auth
    GW -->|Verified Request| CR
    CR --> DB
</div></code></pre>
<h3 id="32-%E8%A8%AD%E8%A8%88%E5%8E%9F%E5%89%87">3.2 è¨­è¨ˆåŸå‰‡</h3>
<p>æœ¬ç³»çµ±æ¡ç”¨<strong>è‡ªå»ºæœ€å° OIDC Auth Service</strong> ä½œç‚ºåˆå§‹æ–¹æ¡ˆï¼Œä¸¦éµå¾ªä»¥ä¸‹åŸå‰‡ä»¥ç¢ºä¿æœªä¾†å¯ç„¡ç—›å‡ç´šè‡³ Keycloak æˆ– Firebase Authï¼š</p>
<ol>
<li><strong>API é©—è­‰æ–¹å¼å›ºå®šç‚º Bearer JWT</strong> - ä¸æ··ç”¨ API Key æˆ–å…¶ä»–èªè­‰æ–¹å¼</li>
<li><strong>JWT Claims éµå¾ª OIDC æ¨™æº–</strong> - ä½¿ç”¨æ¨™æº–æ¬„ä½ï¼Œä¸è‡ªå‰µæ ¸å¿ƒæ¬„ä½</li>
<li><strong>JWKS Endpoint éµå¾ªæ…£ä¾‹</strong> - ä½¿ç”¨ <code>/.well-known/jwks.json</code></li>
<li><strong>èº«ä»½åˆ†é›¢è¨­è¨ˆ</strong> - å¤–éƒ¨èº«ä»½ï¼ˆIdP subï¼‰èˆ‡å…§éƒ¨èº«ä»½ï¼ˆinternalUserIdï¼‰åˆ†é›¢</li>
<li><strong>æˆæ¬Šé‚è¼¯ç¨ç«‹æ–¼ IdP</strong> - æ¬Šé™è³‡æ–™å­˜æ”¾åœ¨è‡ªå·±çš„ Firestoreï¼Œä¸ä¾è³´ IdP è§’è‰²</li>
</ol>
<hr>
<h2 id="4-gcp-%E5%85%83%E4%BB%B6%E8%AA%AA%E6%98%8E">4. GCP å…ƒä»¶èªªæ˜</h2>
<h3 id="41-auth-service%E8%87%AA%E5%BB%BA%E6%9C%80%E5%B0%8F-oidc-provider">4.1 Auth Serviceï¼ˆè‡ªå»ºæœ€å° OIDC Providerï¼‰</h3>
<p>æœ¬ç³»çµ±åˆæœŸæ¡ç”¨è‡ªå»º Auth Serviceï¼Œå¯¦ä½œ OIDC çš„æœ€å°å­é›†åˆï¼Œæœªä¾†å¯å¹³æ»‘å‡ç´šè‡³ Keycloak æˆ– Firebase Authã€‚</p>
<h4 id="411-auth-service-%E8%81%B7%E8%B2%AC">4.1.1 Auth Service è·è²¬</h4>
<ul>
<li>ä½¿ç”¨è€…è¨»å†Šã€ç™»å…¥</li>
<li>ç°½ç™¼çŸ­æ•ˆ JWTï¼ˆAccess Tokenï¼‰</li>
<li>æä¾› JWKS Endpoint ä¾› API Gateway é©—ç°½</li>
</ul>
<h4 id="412-auth-service-endpoints">4.1.2 Auth Service Endpoints</h4>
<table>
<thead>
<tr>
<th>Endpoint</th>
<th>èªªæ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>POST /auth/register</code></td>
<td>ä½¿ç”¨è€…è¨»å†Š</td>
</tr>
<tr>
<td><code>POST /auth/token</code></td>
<td>ç™»å…¥å–å¾— JWT</td>
</tr>
<tr>
<td><code>GET /.well-known/jwks.json</code></td>
<td>å…¬é‘° JWKS Endpoint</td>
</tr>
</tbody>
</table>
<h4 id="413-jwt-token-%E8%A6%8F%E6%A0%BC">4.1.3 JWT Token è¦æ ¼</h4>
<p><strong>Token é¡å‹</strong>ï¼šAccess Tokenï¼ˆçŸ­æ•ˆï¼Œä¸å¯¦ä½œ Refresh Tokenï¼‰</p>
<p><strong>Token æœ‰æ•ˆæœŸ</strong>ï¼šå»ºè­° 1 å°æ™‚</p>
<p><strong>å¿…è¦ Claimsï¼ˆéµå¾ª OIDC æ¨™æº–ï¼‰</strong>ï¼š</p>
<table>
<thead>
<tr>
<th>Claim</th>
<th>èªªæ˜</th>
<th>ç¯„ä¾‹</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>iss</code></td>
<td>Issuer URLï¼ˆHTTPSï¼Œç©©å®šä¸è®Šï¼‰</td>
<td><code>https://auth.yourdomain.com</code></td>
</tr>
<tr>
<td><code>aud</code></td>
<td>Audienceï¼ˆAPI Gateway é©—è­‰ç”¨ï¼‰</td>
<td><code>baby-weight-api</code></td>
</tr>
<tr>
<td><code>sub</code></td>
<td>Subjectï¼ˆå¤–éƒ¨ä½¿ç”¨è€…å”¯ä¸€è­˜åˆ¥ï¼‰</td>
<td><code>user_01JHXYZ...</code>ï¼ˆULID æ ¼å¼ï¼‰</td>
</tr>
<tr>
<td><code>exp</code></td>
<td>Token éæœŸæ™‚é–“</td>
<td>Unix timestamp</td>
</tr>
<tr>
<td><code>iat</code></td>
<td>Token ç°½ç™¼æ™‚é–“</td>
<td>Unix timestamp</td>
</tr>
</tbody>
</table>
<p><strong>é¸ç”¨ Claimsï¼ˆå»ºè­°åŠ å…¥ï¼‰</strong>ï¼š</p>
<table>
<thead>
<tr>
<th>Claim</th>
<th>èªªæ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>email</code></td>
<td>ä½¿ç”¨è€… Email</td>
</tr>
<tr>
<td><code>scope</code></td>
<td>æ¬Šé™ç¯„åœï¼Œå¦‚ <code>weights:read weights:write</code></td>
</tr>
</tbody>
</table>
<h4 id="414-jwks-%E8%A6%8F%E6%A0%BC">4.1.4 JWKS è¦æ ¼</h4>
<pre class="hljs"><code><div>{
  <span class="hljs-attr">"keys"</span>: [
    {
      <span class="hljs-attr">"kty"</span>: <span class="hljs-string">"RSA"</span>,
      <span class="hljs-attr">"kid"</span>: <span class="hljs-string">"key-2026-01"</span>,
      <span class="hljs-attr">"use"</span>: <span class="hljs-string">"sig"</span>,
      <span class="hljs-attr">"alg"</span>: <span class="hljs-string">"RS256"</span>,
      <span class="hljs-attr">"n"</span>: <span class="hljs-string">"..."</span>,
      <span class="hljs-attr">"e"</span>: <span class="hljs-string">"AQAB"</span>
    }
  ]
}
</div></code></pre>
<p><strong>é‡é»</strong>ï¼š</p>
<ul>
<li>æ¯æŠŠ key å¿…é ˆæœ‰å”¯ä¸€ <code>kid</code></li>
<li>æ”¯æ´ key rotationï¼ˆæ–°å¢ key å¾Œï¼ŒèˆŠ key ä¿ç•™ä¸€æ®µæ™‚é–“ï¼‰</li>
</ul>
<h4 id="415-%E7%99%BB%E5%85%A5%E6%96%B9%E5%BC%8F">4.1.5 ç™»å…¥æ–¹å¼</h4>
<ul>
<li>Email / Passwordï¼ˆåˆæœŸï¼‰</li>
<li>Google OAuthï¼ˆæœªä¾†å¯æ“´å……ï¼‰</li>
</ul>
<hr>
<h3 id="42-api-gateway">4.2 API Gateway</h3>
<ul>
<li>ç³»çµ±å°å¤–å”¯ä¸€å…¥å£</li>
<li>è² è²¬äº‹é …ï¼š
<ul>
<li>HTTPS termination</li>
<li>JWT é©—è­‰ï¼ˆAuthNï¼‰- é€é JWKS é©—ç°½</li>
<li>API routing</li>
<li>API versioning</li>
<li>åŸºæœ¬ rate limit / quotaï¼ˆå¯é¸ï¼‰</li>
</ul>
</li>
</ul>
<p><strong>JWT é©—è­‰è¨­å®š</strong>ï¼š</p>
<table>
<thead>
<tr>
<th>è¨­å®šé …</th>
<th>èªªæ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>issuer</code></td>
<td>Auth Service çš„ issuer URL</td>
</tr>
<tr>
<td><code>jwks_uri</code></td>
<td><code>https://auth.yourdomain.com/.well-known/jwks.json</code></td>
</tr>
<tr>
<td><code>audience</code></td>
<td><code>baby-weight-api</code></td>
</tr>
</tbody>
</table>
<blockquote>
<p>ğŸ’¡ <strong>å‡ç´šæç¤º</strong>ï¼šæœªä¾†åˆ‡æ› IdP æ™‚ï¼Œåªéœ€ä¿®æ”¹ <code>issuer</code> èˆ‡ <code>jwks_uri</code> å³å¯</p>
</blockquote>
<p><strong>ä¸è² è²¬æ¥­å‹™é‚è¼¯èˆ‡è³‡æ–™æ¬Šé™åˆ¤æ–·</strong></p>
<hr>
<h3 id="43-cloud-run-%E2%80%93-weight-api-service">4.3 Cloud Run â€“ Weight API Service</h3>
<ul>
<li>Stateless REST API</li>
<li>ä¸»è¦è²¬ä»»ï¼š
<ul>
<li>å¾ JWT å–å¾—å¤–éƒ¨èº«ä»½ï¼ˆ<code>iss</code> + <code>sub</code>ï¼‰</li>
<li>é€é <code>identity_links</code> è§£æç‚º <code>internalUserId</code></li>
<li>æª¢æŸ¥ä½¿ç”¨è€…å°å¬°å…’çš„å­˜å–æ¬Šé™ï¼ˆAuthZï¼‰</li>
<li>å¯«å…¥ / æŸ¥è©¢ Firestore</li>
</ul>
</li>
<li>æ”¯æ´è‡ªå‹•æ°´å¹³æ“´å±•</li>
<li><code>min-instances = 0</code></li>
</ul>
<p><strong>èº«ä»½è§£ææµç¨‹</strong>ï¼š</p>
<pre class="hljs"><code><div>JWT.sub (å¤–éƒ¨èº«ä»½) â†’ identity_links â†’ internalUserId (å…§éƒ¨èº«ä»½) â†’ memberships (æ¬Šé™)
</div></code></pre>
<blockquote>
<p>ğŸ’¡ <strong>å‡ç´šæç¤º</strong>ï¼šæ› IdP å¾Œï¼Œåªéœ€åœ¨ <code>identity_links</code> æ–°å¢ä¸€ç­†å°æ‡‰ï¼Œå³å¯ç¶å®šåˆ°åŒä¸€å€‹ <code>internalUserId</code></p>
</blockquote>
<hr>
<h3 id="44-firestorenative-mode">4.4 Firestoreï¼ˆNative Modeï¼‰</h3>
<ul>
<li>NoSQL Document Database</li>
<li>é«˜å¯ç”¨ã€å…ç¶­é‹</li>
<li>ä½¿ç”¨ Document çµæ§‹æ”¯æ´å¤šä½¿ç”¨è€…å…±äº«è³‡æ–™</li>
</ul>
<hr>
<h2 id="5-%E8%AA%8D%E8%AD%89%E8%88%87%E6%8E%88%E6%AC%8A%E8%A8%AD%E8%A8%88">5. èªè­‰èˆ‡æˆæ¬Šè¨­è¨ˆ</h2>
<h3 id="51-%E8%AA%8D%E8%AD%89%E6%B5%81%E7%A8%8Bauthn">5.1 èªè­‰æµç¨‹ï¼ˆAuthNï¼‰</h3>
<pre><code class="language-mermaid"><div class="mermaid">sequenceDiagram
    participant C as Client
    participant A as Auth Service
    participant G as API Gateway
    participant S as Cloud Run

    C->>A: Login (email/password)
    A-->>C: JWT (ID Token)
    C->>G: API Request + Bearer JWT
    G->>G: Verify JWT
    G->>S: Forward verified request
</div></code></pre>
<hr>
<h3 id="52-%E6%8E%88%E6%AC%8A%E6%B5%81%E7%A8%8Bauthz">5.2 æˆæ¬Šæµç¨‹ï¼ˆAuthZï¼‰</h3>
<pre><code class="language-mermaid"><div class="mermaid">sequenceDiagram
    participant S as Cloud Run
    participant D as Firestore

    S->>D: Check baby membership (uid)
    alt Has permission
        S->>D: Write / Read weight
    else No permission
        S-->>S: Return 403 Forbidden
    end
</div></code></pre>
<hr>
<h2 id="6-firestore-%E8%B3%87%E6%96%99%E6%A8%A1%E5%9E%8B%E8%A8%AD%E8%A8%88">6. Firestore è³‡æ–™æ¨¡å‹è¨­è¨ˆ</h2>
<h3 id="61-%E5%85%A7%E9%83%A8%E4%BD%BF%E7%94%A8%E8%80%85-id-%E6%A0%BC%E5%BC%8F">6.1 å…§éƒ¨ä½¿ç”¨è€… ID æ ¼å¼</h3>
<p>æœ¬ç³»çµ±ä½¿ç”¨ <strong>ULID</strong>ï¼ˆUniversally Unique Lexicographically Sortable Identifierï¼‰ä½œç‚º <code>internalUserId</code> æ ¼å¼ï¼š</p>
<ul>
<li>æ ¼å¼ï¼š<code>01JHXYZ1234567890ABCDEF</code>ï¼ˆ26 å­—å…ƒï¼‰</li>
<li>ç‰¹æ€§ï¼š
<ul>
<li>æ™‚é–“æ’åºæ€§ï¼ˆå‰ 10 å­—å…ƒç‚º timestampï¼‰</li>
<li>å…¨åŸŸå”¯ä¸€</li>
<li>URL safe</li>
<li>æ¯” UUID æ›´çŸ­ä¸”å¯æ’åº</li>
</ul>
</li>
</ul>
<h3 id="62-collections-%E7%B5%90%E6%A7%8B">6.2 Collections çµæ§‹</h3>
<pre class="hljs"><code><div># èº«ä»½å°æ‡‰è¡¨ï¼ˆIdP å¯æ›¿æ›è¨­è¨ˆçš„é—œéµï¼‰
identity_links/{linkId}
  - providerIss: &quot;https://auth.yourdomain.com&quot;  # IdP issuer
  - providerSub: &quot;user_01JHXYZ...&quot;              # IdP subject
  - internalUserId: &quot;01JHXYZ...&quot;                # ç³»çµ±å…§éƒ¨ ID (ULID)
  - createdAt

# ä½¿ç”¨è€…è³‡æ–™ï¼ˆä½¿ç”¨ internalUserIdï¼‰
users/{internalUserId}
  - displayName
  - email
  - createdAt

# å¬°å…’è³‡æ–™
babies/{babyId}
  - name
  - birthDate
  - createdAt

# æˆå“¡æ¬Šé™ï¼ˆä½¿ç”¨ internalUserIdï¼‰
babies/{babyId}/members/{internalUserId}
  - role: owner | editor | viewer
  - joinedAt

# é«”é‡è¨˜éŒ„
babies/{babyId}/weights/{weightId}
  - timestamp
  - weight_g
  - note
  - createdBy: {internalUserId}
  - createdAt
</div></code></pre>
<h3 id="63-identitylinks-%E6%9F%A5%E8%A9%A2%E7%B4%A2%E5%BC%95">6.3 identity_links æŸ¥è©¢ç´¢å¼•</h3>
<p>å»ºç«‹è¤‡åˆç´¢å¼•ä»¥æ”¯æ´å¿«é€ŸæŸ¥è©¢ï¼š</p>
<pre class="hljs"><code><div>Collection: identity_links
Fields: providerIss (ASC), providerSub (ASC)
</div></code></pre>
<h3 id="64-%E8%BA%AB%E4%BB%BD%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B">6.4 èº«ä»½è§£ææµç¨‹</h3>
<pre><code class="language-mermaid"><div class="mermaid">sequenceDiagram
    participant S as Cloud Run
    participant D as Firestore

    S->>S: å¾ JWT å–å¾— iss + sub
    S->>D: æŸ¥è©¢ identity_links (iss + sub)
    alt å·²å­˜åœ¨
        D-->>S: å›å‚³ internalUserId
    else é¦–æ¬¡ç™»å…¥
        S->>D: å»ºç«‹æ–° user document
        S->>D: å»ºç«‹ identity_link (iss + sub â†’ internalUserId)
        D-->>S: å›å‚³æ–° internalUserId
    end
    S->>D: ä½¿ç”¨ internalUserId é€²è¡Œå¾ŒçºŒæ“ä½œ
</div></code></pre>
<hr>
<h3 id="65-%E6%AC%8A%E9%99%90%E9%82%8F%E8%BC%AF">6.5 æ¬Šé™é‚è¼¯</h3>
<table>
<thead>
<tr>
<th>Role</th>
<th>Read Weight</th>
<th>Write Weight</th>
<th>Manage Members</th>
</tr>
</thead>
<tbody>
<tr>
<td>owner</td>
<td>âœ…</td>
<td>âœ…</td>
<td>âœ…</td>
</tr>
<tr>
<td>editor</td>
<td>âœ…</td>
<td>âœ…</td>
<td>âŒ</td>
</tr>
<tr>
<td>viewer</td>
<td>âœ…</td>
<td>âŒ</td>
<td>âŒ</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="7-api-%E8%A6%8F%E6%A0%BCv1">7. API è¦æ ¼ï¼ˆv1ï¼‰</h2>
<h3 id="71-%E5%BB%BA%E7%AB%8B%E5%AC%B0%E5%85%92">7.1 å»ºç«‹å¬°å…’</h3>
<p><strong>POST</strong> <code>/v1/babies</code></p>
<p>Request Body:</p>
<pre class="hljs"><code><div>{
  <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Baby A"</span>,
  <span class="hljs-attr">"birthDate"</span>: <span class="hljs-string">"2025-12-01"</span>
}
</div></code></pre>
<p>Response:</p>
<pre class="hljs"><code><div>{
  <span class="hljs-attr">"babyId"</span>: <span class="hljs-string">"abc123"</span>
}
</div></code></pre>
<hr>
<h3 id="72-%E6%96%B0%E5%A2%9E%E9%AB%94%E9%87%8D%E7%B4%80%E9%8C%84">7.2 æ–°å¢é«”é‡ç´€éŒ„</h3>
<p><strong>POST</strong> <code>/v1/babies/{babyId}/weights</code></p>
<p>Headers:</p>
<ul>
<li>Authorization: Bearer <JWT></li>
<li>Idempotency-Key: <uuid></li>
</ul>
<p>Request Body:</p>
<pre class="hljs"><code><div>{
  <span class="hljs-attr">"timestamp"</span>: <span class="hljs-string">"2026-01-10T08:00:00Z"</span>,
  <span class="hljs-attr">"weight_g"</span>: <span class="hljs-number">4200</span>,
  <span class="hljs-attr">"note"</span>: <span class="hljs-string">"Morning measurement"</span>
}
</div></code></pre>
<hr>
<h3 id="73-%E6%9F%A5%E8%A9%A2%E9%AB%94%E9%87%8D%E7%B4%80%E9%8C%84">7.3 æŸ¥è©¢é«”é‡ç´€éŒ„</h3>
<p><strong>GET</strong> <code>/v1/babies/{babyId}/weights?from=2026-01-01&amp;to=2026-01-31</code></p>
<p>Response:</p>
<pre class="hljs"><code><div>[
  {
    <span class="hljs-attr">"timestamp"</span>: <span class="hljs-string">"2026-01-10T08:00:00Z"</span>,
    <span class="hljs-attr">"weight_g"</span>: <span class="hljs-number">4200</span>,
    <span class="hljs-attr">"note"</span>: <span class="hljs-string">"Morning measurement"</span>
  }
]
</div></code></pre>
<hr>
<h2 id="8-%E9%8C%AF%E8%AA%A4%E8%99%95%E7%90%86">8. éŒ¯èª¤è™•ç†</h2>
<table>
<thead>
<tr>
<th>HTTP Status</th>
<th>èªªæ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>400</td>
<td>Request æ ¼å¼éŒ¯èª¤</td>
</tr>
<tr>
<td>401</td>
<td>æœªé€šéèªè­‰</td>
</tr>
<tr>
<td>403</td>
<td>ç„¡å­˜å–æ¬Šé™</td>
</tr>
<tr>
<td>404</td>
<td>è³‡æºä¸å­˜åœ¨</td>
</tr>
<tr>
<td>409</td>
<td>é‡è¤‡è«‹æ±‚ï¼ˆIdempotencyï¼‰</td>
</tr>
<tr>
<td>500</td>
<td>å…§éƒ¨éŒ¯èª¤</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="9-%E9%83%A8%E7%BD%B2%E8%88%87%E7%B6%AD%E9%81%8B%E5%BB%BA%E8%AD%B0">9. éƒ¨ç½²èˆ‡ç¶­é‹å»ºè­°</h2>
<h3 id="91-%E5%9F%BA%E7%A4%8E%E8%A8%AD%E6%96%BD%E5%8D%B3%E7%A8%8B%E5%BC%8F%E7%A2%BCiac">9.1 åŸºç¤è¨­æ–½å³ç¨‹å¼ç¢¼ï¼ˆIaCï¼‰</h3>
<p>æœ¬å°ˆæ¡ˆä½¿ç”¨ <strong>Terraform</strong> ç®¡ç†æ‰€æœ‰ GCP åŸºç¤å»ºè¨­ï¼Œç¢ºä¿ç’°å¢ƒä¸€è‡´æ€§èˆ‡å¯é‡ç¾æ€§ã€‚</p>
<h4 id="911-terraform-%E7%AE%A1%E7%90%86%E7%9A%84-gcp-%E8%B3%87%E6%BA%90">9.1.1 Terraform ç®¡ç†çš„ GCP è³‡æº</h4>
<table>
<thead>
<tr>
<th>è³‡æºé¡å‹</th>
<th>èªªæ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>google_project</code></td>
<td>GCP å°ˆæ¡ˆï¼ˆå¯é¸ï¼Œè‹¥å·²å­˜åœ¨å‰‡ importï¼‰</td>
</tr>
<tr>
<td><code>google_cloud_run_v2_service</code></td>
<td>Weight API Service</td>
</tr>
<tr>
<td><code>google_cloud_run_v2_service</code></td>
<td>Auth Service</td>
</tr>
<tr>
<td><code>google_api_gateway_api</code></td>
<td>API Gateway å®šç¾©</td>
</tr>
<tr>
<td><code>google_api_gateway_api_config</code></td>
<td>API Gateway è¨­å®šï¼ˆå« OpenAPI specï¼‰</td>
</tr>
<tr>
<td><code>google_api_gateway_gateway</code></td>
<td>API Gateway å¯¦ä¾‹</td>
</tr>
<tr>
<td><code>google_firestore_database</code></td>
<td>Firestore è³‡æ–™åº«</td>
</tr>
<tr>
<td><code>google_firestore_index</code></td>
<td>Firestore è¤‡åˆç´¢å¼•</td>
</tr>
<tr>
<td><code>google_secret_manager_secret</code></td>
<td>æ©Ÿæ•è³‡æ–™ï¼ˆJWT signing key ç­‰ï¼‰</td>
</tr>
<tr>
<td><code>google_service_account</code></td>
<td>æœå‹™å¸³è™Ÿ</td>
</tr>
<tr>
<td><code>google_project_iam_member</code></td>
<td>IAM æ¬Šé™ç¶å®š</td>
</tr>
<tr>
<td><code>google_artifact_registry_repository</code></td>
<td>Container Registry</td>
</tr>
</tbody>
</table>
<h4 id="912-terraform-%E5%B0%88%E6%A1%88%E7%B5%90%E6%A7%8B">9.1.2 Terraform å°ˆæ¡ˆçµæ§‹</h4>
<pre class="hljs"><code><div>terraform/
â”œâ”€â”€ environments/
â”‚   â”œâ”€â”€ dev/
â”‚   â”‚   â”œâ”€â”€ main.tf
â”‚   â”‚   â”œâ”€â”€ variables.tf
â”‚   â”‚   â”œâ”€â”€ terraform.tfvars
â”‚   â”‚   â””â”€â”€ backend.tf
â”‚   â”œâ”€â”€ staging/
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ prod/
â”‚       â””â”€â”€ ...
â”œâ”€â”€ modules/
â”‚   â”œâ”€â”€ cloud-run/
â”‚   â”‚   â”œâ”€â”€ main.tf
â”‚   â”‚   â”œâ”€â”€ variables.tf
â”‚   â”‚   â””â”€â”€ outputs.tf
â”‚   â”œâ”€â”€ api-gateway/
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ firestore/
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ auth-service/
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ iam/
â”‚       â””â”€â”€ ...
â””â”€â”€ shared/
    â””â”€â”€ backend.tf.example
</div></code></pre>
<h4 id="913-%E7%92%B0%E5%A2%83%E5%88%86%E9%9B%A2%E7%AD%96%E7%95%A5">9.1.3 ç’°å¢ƒåˆ†é›¢ç­–ç•¥</h4>
<table>
<thead>
<tr>
<th>ç’°å¢ƒ</th>
<th>ç”¨é€”</th>
<th>GCP Project</th>
<th>ç‰¹æ€§</th>
</tr>
</thead>
<tbody>
<tr>
<td>dev</td>
<td>é–‹ç™¼æ¸¬è©¦</td>
<td><code>baby-weight-dev</code></td>
<td>min-instances=0, è¼ƒä½è¦æ ¼</td>
</tr>
<tr>
<td>staging</td>
<td>æ•´åˆæ¸¬è©¦</td>
<td><code>baby-weight-staging</code></td>
<td>æ¨¡æ“¬ prod è¨­å®š</td>
</tr>
<tr>
<td>prod</td>
<td>æ­£å¼ç’°å¢ƒ</td>
<td><code>baby-weight-prod</code></td>
<td>min-instances=1, é«˜å¯ç”¨</td>
</tr>
</tbody>
</table>
<h4 id="914-terraform-state-%E7%AE%A1%E7%90%86">9.1.4 Terraform State ç®¡ç†</h4>
<p>ä½¿ç”¨ GCS Backend å„²å­˜ Terraform stateï¼š</p>
<pre class="hljs"><code><div># backend.tf
terraform {
  backend &quot;gcs&quot; {
    bucket = &quot;baby-weight-terraform-state&quot;
    prefix = &quot;env/dev&quot;
  }
}
</div></code></pre>
<p><strong>State éš”é›¢åŸå‰‡</strong>ï¼š</p>
<ul>
<li>æ¯å€‹ç’°å¢ƒä½¿ç”¨ç¨ç«‹çš„ state fileï¼ˆé€éä¸åŒ prefixï¼‰</li>
<li>State bucket å•Ÿç”¨ç‰ˆæœ¬æ§åˆ¶</li>
<li>é™åˆ¶ state bucket çš„å­˜å–æ¬Šé™</li>
</ul>
<h4 id="915-%E6%A9%9F%E6%95%8F%E8%B3%87%E6%96%99%E8%99%95%E7%90%86">9.1.5 æ©Ÿæ•è³‡æ–™è™•ç†</h4>
<p>Terraform ä¸ç›´æ¥ç®¡ç†æ©Ÿæ•è³‡æ–™å…§å®¹ï¼Œåƒ…å»ºç«‹ Secret Manager è³‡æºï¼š</p>
<pre class="hljs"><code><div># å»ºç«‹ secret å®¹å™¨
resource &quot;google_secret_manager_secret&quot; &quot;jwt_signing_key&quot; {
  secret_id = &quot;jwt-signing-key&quot;
  replication {
    auto {}
  }
}

# secret å€¼é€é gcloud æˆ– CI/CD æ‰‹å‹•è¨­å®š
# gcloud secrets versions add jwt-signing-key --data-file=key.pem
</div></code></pre>
<h4 id="916-%E9%83%A8%E7%BD%B2%E6%B5%81%E7%A8%8B">9.1.6 éƒ¨ç½²æµç¨‹</h4>
<pre><code class="language-mermaid"><div class="mermaid">flowchart LR
    subgraph CI/CD
        A[Push Code] --> B[Build Container]
        B --> C[Push to Artifact Registry]
    end
    
    subgraph Terraform
        D[terraform plan] --> E[Review]
        E --> F[terraform apply]
    end
    
    C --> D
    F --> G[Cloud Run Updated]
</div></code></pre>
<p><strong>éƒ¨ç½²æ­¥é©Ÿ</strong>ï¼š</p>
<ol>
<li><strong>Container Build</strong>ï¼šCI/CD å»ºç½®ä¸¦æ¨é€ container image</li>
<li><strong>Terraform Plan</strong>ï¼šæª¢è¦–åŸºç¤å»ºè¨­è®Šæ›´</li>
<li><strong>Terraform Apply</strong>ï¼šå¥—ç”¨è®Šæ›´ï¼ˆå« Cloud Run æ–°ç‰ˆæœ¬éƒ¨ç½²ï¼‰</li>
</ol>
<h4 id="917-%E9%97%9C%E9%8D%B5-terraform-%E8%A8%AD%E5%AE%9A%E7%AF%84%E4%BE%8B">9.1.7 é—œéµ Terraform è¨­å®šç¯„ä¾‹</h4>
<p><strong>Cloud Run Service</strong>ï¼š</p>
<pre class="hljs"><code><div>resource &quot;google_cloud_run_v2_service&quot; &quot;weight_api&quot; {
  name     = &quot;weight-api&quot;
  location = var.region
  
  template {
    containers {
      image = &quot;${var.region}-docker.pkg.dev/${var.project_id}/baby-weight/weight-api:${var.image_tag}&quot;
      
      env {
        name  = &quot;AUTH_MODE&quot;
        value = &quot;oidc&quot;
      }
      env {
        name  = &quot;AUTH_ISSUER&quot;
        value = var.auth_issuer
      }
      env {
        name = &quot;JWT_SIGNING_KEY&quot;
        value_source {
          secret_key_ref {
            secret  = google_secret_manager_secret.jwt_signing_key.secret_id
            version = &quot;latest&quot;
          }
        }
      }
    }
    
    scaling {
      min_instance_count = var.environment == &quot;prod&quot; ? 1 : 0
      max_instance_count = 10
    }
  }
  
  traffic {
    type    = &quot;TRAFFIC_TARGET_ALLOCATION_TYPE_LATEST&quot;
    percent = 100
  }
}
</div></code></pre>
<p><strong>Firestore Index</strong>ï¼š</p>
<pre class="hljs"><code><div>resource &quot;google_firestore_index&quot; &quot;identity_links_lookup&quot; {
  project    = var.project_id
  database   = &quot;(default)&quot;
  collection = &quot;identity_links&quot;

  fields {
    field_path = &quot;providerIss&quot;
    order      = &quot;ASCENDING&quot;
  }
  fields {
    field_path = &quot;providerSub&quot;
    order      = &quot;ASCENDING&quot;
  }
}
</div></code></pre>
<h3 id="92-cloud-run-%E8%A8%AD%E5%AE%9A">9.2 Cloud Run è¨­å®š</h3>
<ul>
<li>CPU only during request</li>
<li>Auto scale enabled</li>
<li>ç’°å¢ƒè®Šæ•¸é€é Terraform ç®¡ç†</li>
</ul>
<h3 id="93-firestore-%E8%A8%AD%E5%AE%9A">9.3 Firestore è¨­å®š</h3>
<ul>
<li>å»ºç«‹ timestamp range query index</li>
<li>å»ºç«‹ identity_links è¤‡åˆç´¢å¼•</li>
</ul>
<h3 id="94-logging-%E8%A8%AD%E5%AE%9A">9.4 Logging è¨­å®š</h3>
<ul>
<li>è¨­å®š log retention</li>
<li>å»ºç«‹ log-based metricsï¼ˆå¯é¸ï¼‰</li>
</ul>
<h3 id="95-secrets-%E7%AE%A1%E7%90%86">9.5 Secrets ç®¡ç†</h3>
<ul>
<li>ä½¿ç”¨ Secret Manager å­˜æ”¾ï¼š
<ul>
<li>JWT Signing Keyï¼ˆRSA Private Keyï¼‰</li>
<li>å…¶ä»–æ©Ÿæ•è¨­å®š</li>
</ul>
</li>
<li>Cloud Run é€é IAM å­˜å– secrets</li>
</ul>
<hr>
<h3 id="96-github-actions-cicd">9.6 GitHub Actions CI/CD</h3>
<p>æœ¬å°ˆæ¡ˆä½¿ç”¨ <strong>GitHub Actions</strong> ä½œç‚º CI/CD å¹³å°ï¼Œæ•´åˆ Terraform é€²è¡Œè‡ªå‹•åŒ–éƒ¨ç½²ã€‚</p>
<h4 id="961-workflow-%E7%B8%BD%E8%A6%BD">9.6.1 Workflow ç¸½è¦½</h4>
<pre><code class="language-mermaid"><div class="mermaid">flowchart TD
    subgraph PR["Pull Request"]
        A[Push to Branch] --> B[CI: Test & Lint]
        B --> C[Build Container]
        C --> D[Terraform Plan]
        D --> E[Post Plan to PR]
    end
    
    subgraph Merge["Merge to main"]
        F[Merge PR] --> G[Build & Push Container]
        G --> H[Terraform Apply - Dev]
        H --> I{Manual Approval}
        I --> J[Terraform Apply - Prod]
    end
    
    PR --> Merge
</div></code></pre>
<h4 id="962-github-actions-%E6%AA%94%E6%A1%88%E7%B5%90%E6%A7%8B">9.6.2 GitHub Actions æª”æ¡ˆçµæ§‹</h4>
<pre class="hljs"><code><div>.github/
â”œâ”€â”€ workflows/
â”‚   â”œâ”€â”€ ci.yml              # PR æ™‚åŸ·è¡Œï¼štest, lint, build
â”‚   â”œâ”€â”€ deploy-dev.yml      # merge åˆ° main æ™‚éƒ¨ç½² dev
â”‚   â”œâ”€â”€ deploy-prod.yml     # æ‰‹å‹•è§¸ç™¼éƒ¨ç½² prod
â”‚   â””â”€â”€ terraform-plan.yml  # PR æ™‚åŸ·è¡Œ terraform plan
â””â”€â”€ actions/
    â””â”€â”€ setup-gcp/
        â””â”€â”€ action.yml      # å…±ç”¨çš„ GCP èªè­‰ action
</div></code></pre>
<h4 id="963-gcp-%E8%AA%8D%E8%AD%89%E8%A8%AD%E5%AE%9Aworkload-identity-federation">9.6.3 GCP èªè­‰è¨­å®šï¼ˆWorkload Identity Federationï¼‰</h4>
<p>ä½¿ç”¨ <strong>Workload Identity Federation</strong> å–ä»£ Service Account Keyï¼Œæ›´å®‰å…¨ï¼š</p>
<p><strong>Terraform è¨­å®šï¼ˆå»ºç«‹ Workload Identity Poolï¼‰</strong>ï¼š</p>
<pre class="hljs"><code><div># å»ºç«‹ Workload Identity Pool
resource &quot;google_iam_workload_identity_pool&quot; &quot;github&quot; {
  workload_identity_pool_id = &quot;github-actions&quot;
  display_name              = &quot;GitHub Actions&quot;
}

# å»ºç«‹ Provider
resource &quot;google_iam_workload_identity_pool_provider&quot; &quot;github&quot; {
  workload_identity_pool_id          = google_iam_workload_identity_pool.github.workload_identity_pool_id
  workload_identity_pool_provider_id = &quot;github-provider&quot;
  
  attribute_mapping = {
    &quot;google.subject&quot;       = &quot;assertion.sub&quot;
    &quot;attribute.actor&quot;      = &quot;assertion.actor&quot;
    &quot;attribute.repository&quot; = &quot;assertion.repository&quot;
  }
  
  oidc {
    issuer_uri = &quot;https://token.actions.githubusercontent.com&quot;
  }
}

# ç¶å®š Service Account
resource &quot;google_service_account_iam_member&quot; &quot;github_actions&quot; {
  service_account_id = google_service_account.deployer.name
  role               = &quot;roles/iam.workloadIdentityUser&quot;
  member             = &quot;principalSet://iam.googleapis.com/${google_iam_workload_identity_pool.github.name}/attribute.repository/${var.github_repo}&quot;
}
</div></code></pre>
<p><strong>GitHub Secrets è¨­å®š</strong>ï¼š</p>
<table>
<thead>
<tr>
<th>Secret åç¨±</th>
<th>èªªæ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>GCP_PROJECT_ID</code></td>
<td>GCP å°ˆæ¡ˆ ID</td>
</tr>
<tr>
<td><code>GCP_WORKLOAD_IDENTITY_PROVIDER</code></td>
<td>Workload Identity Provider å®Œæ•´è·¯å¾‘</td>
</tr>
<tr>
<td><code>GCP_SERVICE_ACCOUNT</code></td>
<td>éƒ¨ç½²ç”¨ Service Account Email</td>
</tr>
</tbody>
</table>
<h4 id="964-ci-workflowciyml">9.6.4 CI Workflowï¼ˆci.ymlï¼‰</h4>
<pre class="hljs"><code><div><span class="hljs-attr">name:</span> <span class="hljs-string">CI</span>

<span class="hljs-attr">on:</span>
  <span class="hljs-attr">pull_request:</span>
    <span class="hljs-attr">branches:</span> <span class="hljs-string">[main]</span>
  <span class="hljs-attr">push:</span>
    <span class="hljs-attr">branches:</span> <span class="hljs-string">[main]</span>

<span class="hljs-attr">env:</span>
  <span class="hljs-attr">PYTHON_VERSION:</span> <span class="hljs-string">'3.12'</span>

<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">test:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v4</span>
      
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Set</span> <span class="hljs-string">up</span> <span class="hljs-string">Python</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/setup-python@v5</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">python-version:</span> <span class="hljs-string">${{</span> <span class="hljs-string">env.PYTHON_VERSION</span> <span class="hljs-string">}}</span>
      
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">dependencies</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
</span>      
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">tests</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">pytest</span> <span class="hljs-string">-v</span> <span class="hljs-string">--cov=.</span> <span class="hljs-string">--cov-report=xml</span>
      
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Upload</span> <span class="hljs-string">coverage</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">codecov/codecov-action@v4</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">files:</span> <span class="hljs-string">./coverage.xml</span>

  <span class="hljs-attr">lint:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v4</span>
      
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Set</span> <span class="hljs-string">up</span> <span class="hljs-string">Python</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/setup-python@v5</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">python-version:</span> <span class="hljs-string">${{</span> <span class="hljs-string">env.PYTHON_VERSION</span> <span class="hljs-string">}}</span>
      
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">linters</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          pip install ruff mypy
</span>      
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">Ruff</span> <span class="hljs-string">(linter</span> <span class="hljs-string">+</span> <span class="hljs-string">formatter</span> <span class="hljs-string">check)</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">ruff</span> <span class="hljs-string">check</span> <span class="hljs-string">.</span> <span class="hljs-string">&amp;&amp;</span> <span class="hljs-string">ruff</span> <span class="hljs-string">format</span> <span class="hljs-string">--check</span> <span class="hljs-string">.</span>
      
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">MyPy</span> <span class="hljs-string">(type</span> <span class="hljs-string">check)</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">mypy</span> <span class="hljs-string">.</span>

  <span class="hljs-attr">build:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    <span class="hljs-attr">needs:</span> <span class="hljs-string">[test,</span> <span class="hljs-string">lint]</span>
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v4</span>
      
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Build</span> <span class="hljs-string">container</span> <span class="hljs-string">(test</span> <span class="hljs-string">only)</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          docker build -t weight-api:test -f api/Dockerfile .
          docker build -t auth-service:test -f auth/Dockerfile .
</span></div></code></pre>
<h4 id="965-deploy-dev-workflowdeploy-devyml">9.6.5 Deploy Dev Workflowï¼ˆdeploy-dev.ymlï¼‰</h4>
<pre class="hljs"><code><div><span class="hljs-attr">name:</span> <span class="hljs-string">Deploy</span> <span class="hljs-string">to</span> <span class="hljs-string">Dev</span>

<span class="hljs-attr">on:</span>
  <span class="hljs-attr">push:</span>
    <span class="hljs-attr">branches:</span> <span class="hljs-string">[main]</span>

<span class="hljs-attr">env:</span>
  <span class="hljs-attr">REGION:</span> <span class="hljs-string">asia-east1</span>
  <span class="hljs-attr">ENVIRONMENT:</span> <span class="hljs-string">dev</span>

<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">build-and-push:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    <span class="hljs-attr">permissions:</span>
      <span class="hljs-attr">contents:</span> <span class="hljs-string">read</span>
      <span class="hljs-attr">id-token:</span> <span class="hljs-string">write</span>  <span class="hljs-comment"># éœ€è¦æ­¤æ¬Šé™ä½¿ç”¨ Workload Identity</span>
    
    <span class="hljs-attr">outputs:</span>
      <span class="hljs-attr">image_tag:</span> <span class="hljs-string">${{</span> <span class="hljs-string">steps.meta.outputs.version</span> <span class="hljs-string">}}</span>
    
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v4</span>
      
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Authenticate</span> <span class="hljs-string">to</span> <span class="hljs-string">GCP</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">google-github-actions/auth@v2</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">workload_identity_provider:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.GCP_WORKLOAD_IDENTITY_PROVIDER</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">service_account:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.GCP_SERVICE_ACCOUNT</span> <span class="hljs-string">}}</span>
      
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Set</span> <span class="hljs-string">up</span> <span class="hljs-string">Cloud</span> <span class="hljs-string">SDK</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">google-github-actions/setup-gcloud@v2</span>
      
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Configure</span> <span class="hljs-string">Docker</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">gcloud</span> <span class="hljs-string">auth</span> <span class="hljs-string">configure-docker</span> <span class="hljs-string">${{</span> <span class="hljs-string">env.REGION</span> <span class="hljs-string">}}-docker.pkg.dev</span>
      
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Docker</span> <span class="hljs-string">meta</span>
        <span class="hljs-attr">id:</span> <span class="hljs-string">meta</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">docker/metadata-action@v5</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">images:</span> <span class="hljs-string">${{</span> <span class="hljs-string">env.REGION</span> <span class="hljs-string">}}-docker.pkg.dev/${{</span> <span class="hljs-string">secrets.GCP_PROJECT_ID</span> <span class="hljs-string">}}/baby-weight/weight-api</span>
          <span class="hljs-attr">tags:</span> <span class="hljs-string">|
            type=sha,prefix=
            type=raw,value=latest
</span>      
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Build</span> <span class="hljs-string">and</span> <span class="hljs-string">push</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">docker/build-push-action@v5</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">context:</span> <span class="hljs-string">.</span>
          <span class="hljs-attr">file:</span> <span class="hljs-string">./api/Dockerfile</span>
          <span class="hljs-attr">push:</span> <span class="hljs-literal">true</span>
          <span class="hljs-attr">tags:</span> <span class="hljs-string">${{</span> <span class="hljs-string">steps.meta.outputs.tags</span> <span class="hljs-string">}}</span>

  <span class="hljs-attr">terraform-apply:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    <span class="hljs-attr">needs:</span> <span class="hljs-string">build-and-push</span>
    <span class="hljs-attr">permissions:</span>
      <span class="hljs-attr">contents:</span> <span class="hljs-string">read</span>
      <span class="hljs-attr">id-token:</span> <span class="hljs-string">write</span>
    
    <span class="hljs-attr">defaults:</span>
      <span class="hljs-attr">run:</span>
        <span class="hljs-attr">working-directory:</span> <span class="hljs-string">terraform/environments/dev</span>
    
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v4</span>
      
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Authenticate</span> <span class="hljs-string">to</span> <span class="hljs-string">GCP</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">google-github-actions/auth@v2</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">workload_identity_provider:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.GCP_WORKLOAD_IDENTITY_PROVIDER</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">service_account:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.GCP_SERVICE_ACCOUNT</span> <span class="hljs-string">}}</span>
      
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">Terraform</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">hashicorp/setup-terraform@v3</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">terraform_version:</span> <span class="hljs-number">1.7</span><span class="hljs-number">.0</span>
      
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Terraform</span> <span class="hljs-string">Init</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">terraform</span> <span class="hljs-string">init</span>
      
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Terraform</span> <span class="hljs-string">Apply</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">terraform</span> <span class="hljs-string">apply</span> <span class="hljs-string">-auto-approve</span> <span class="hljs-string">-var="image_tag=${{</span> <span class="hljs-string">needs.build-and-push.outputs.image_tag</span> <span class="hljs-string">}}"</span>
</div></code></pre>
<h4 id="966-deploy-prod-workflowdeploy-prodyml">9.6.6 Deploy Prod Workflowï¼ˆdeploy-prod.ymlï¼‰</h4>
<pre class="hljs"><code><div><span class="hljs-attr">name:</span> <span class="hljs-string">Deploy</span> <span class="hljs-string">to</span> <span class="hljs-string">Production</span>

<span class="hljs-attr">on:</span>
  <span class="hljs-attr">workflow_dispatch:</span>  <span class="hljs-comment"># æ‰‹å‹•è§¸ç™¼</span>
    <span class="hljs-attr">inputs:</span>
      <span class="hljs-attr">image_tag:</span>
        <span class="hljs-attr">description:</span> <span class="hljs-string">'Image tag to deploy'</span>
        <span class="hljs-attr">required:</span> <span class="hljs-literal">true</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">string</span>

<span class="hljs-attr">env:</span>
  <span class="hljs-attr">REGION:</span> <span class="hljs-string">asia-east1</span>
  <span class="hljs-attr">ENVIRONMENT:</span> <span class="hljs-string">prod</span>

<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">terraform-plan:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    <span class="hljs-attr">permissions:</span>
      <span class="hljs-attr">contents:</span> <span class="hljs-string">read</span>
      <span class="hljs-attr">id-token:</span> <span class="hljs-string">write</span>
    
    <span class="hljs-attr">defaults:</span>
      <span class="hljs-attr">run:</span>
        <span class="hljs-attr">working-directory:</span> <span class="hljs-string">terraform/environments/prod</span>
    
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v4</span>
      
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Authenticate</span> <span class="hljs-string">to</span> <span class="hljs-string">GCP</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">google-github-actions/auth@v2</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">workload_identity_provider:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.GCP_WORKLOAD_IDENTITY_PROVIDER_PROD</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">service_account:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.GCP_SERVICE_ACCOUNT_PROD</span> <span class="hljs-string">}}</span>
      
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">Terraform</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">hashicorp/setup-terraform@v3</span>
      
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Terraform</span> <span class="hljs-string">Init</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">terraform</span> <span class="hljs-string">init</span>
      
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Terraform</span> <span class="hljs-string">Plan</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">terraform</span> <span class="hljs-string">plan</span> <span class="hljs-string">-var="image_tag=${{</span> <span class="hljs-string">inputs.image_tag</span> <span class="hljs-string">}}"</span> <span class="hljs-string">-out=tfplan</span>
      
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Upload</span> <span class="hljs-string">plan</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/upload-artifact@v4</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">name:</span> <span class="hljs-string">tfplan</span>
          <span class="hljs-attr">path:</span> <span class="hljs-string">terraform/environments/prod/tfplan</span>

  <span class="hljs-attr">terraform-apply:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    <span class="hljs-attr">needs:</span> <span class="hljs-string">terraform-plan</span>
    <span class="hljs-attr">environment:</span> <span class="hljs-string">production</span>  <span class="hljs-comment"># éœ€è¦ approval</span>
    <span class="hljs-attr">permissions:</span>
      <span class="hljs-attr">contents:</span> <span class="hljs-string">read</span>
      <span class="hljs-attr">id-token:</span> <span class="hljs-string">write</span>
    
    <span class="hljs-attr">defaults:</span>
      <span class="hljs-attr">run:</span>
        <span class="hljs-attr">working-directory:</span> <span class="hljs-string">terraform/environments/prod</span>
    
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v4</span>
      
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Download</span> <span class="hljs-string">plan</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/download-artifact@v4</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">name:</span> <span class="hljs-string">tfplan</span>
          <span class="hljs-attr">path:</span> <span class="hljs-string">terraform/environments/prod</span>
      
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Authenticate</span> <span class="hljs-string">to</span> <span class="hljs-string">GCP</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">google-github-actions/auth@v2</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">workload_identity_provider:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.GCP_WORKLOAD_IDENTITY_PROVIDER_PROD</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">service_account:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.GCP_SERVICE_ACCOUNT_PROD</span> <span class="hljs-string">}}</span>
      
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">Terraform</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">hashicorp/setup-terraform@v3</span>
      
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Terraform</span> <span class="hljs-string">Init</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">terraform</span> <span class="hljs-string">init</span>
      
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Terraform</span> <span class="hljs-string">Apply</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">terraform</span> <span class="hljs-string">apply</span> <span class="hljs-string">tfplan</span>
</div></code></pre>
<h4 id="967-terraform-plan-for-prterraform-planyml">9.6.7 Terraform Plan for PRï¼ˆterraform-plan.ymlï¼‰</h4>
<pre class="hljs"><code><div><span class="hljs-attr">name:</span> <span class="hljs-string">Terraform</span> <span class="hljs-string">Plan</span>

<span class="hljs-attr">on:</span>
  <span class="hljs-attr">pull_request:</span>
    <span class="hljs-attr">paths:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">'terraform/**'</span>

<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">plan:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    <span class="hljs-attr">permissions:</span>
      <span class="hljs-attr">contents:</span> <span class="hljs-string">read</span>
      <span class="hljs-attr">id-token:</span> <span class="hljs-string">write</span>
      <span class="hljs-attr">pull-requests:</span> <span class="hljs-string">write</span>  <span class="hljs-comment"># éœ€è¦æ­¤æ¬Šé™ç™¼è¡¨ PR comment</span>
    
    <span class="hljs-attr">strategy:</span>
      <span class="hljs-attr">matrix:</span>
        <span class="hljs-attr">environment:</span> <span class="hljs-string">[dev,</span> <span class="hljs-string">prod]</span>
    
    <span class="hljs-attr">defaults:</span>
      <span class="hljs-attr">run:</span>
        <span class="hljs-attr">working-directory:</span> <span class="hljs-string">terraform/environments/${{</span> <span class="hljs-string">matrix.environment</span> <span class="hljs-string">}}</span>
    
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v4</span>
      
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Authenticate</span> <span class="hljs-string">to</span> <span class="hljs-string">GCP</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">google-github-actions/auth@v2</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">workload_identity_provider:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.GCP_WORKLOAD_IDENTITY_PROVIDER</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">service_account:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.GCP_SERVICE_ACCOUNT</span> <span class="hljs-string">}}</span>
      
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">Terraform</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">hashicorp/setup-terraform@v3</span>
      
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Terraform</span> <span class="hljs-string">Init</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">terraform</span> <span class="hljs-string">init</span>
      
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Terraform</span> <span class="hljs-string">Plan</span>
        <span class="hljs-attr">id:</span> <span class="hljs-string">plan</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">terraform</span> <span class="hljs-string">plan</span> <span class="hljs-string">-no-color</span>
        <span class="hljs-attr">continue-on-error:</span> <span class="hljs-literal">true</span>
      
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Post</span> <span class="hljs-string">Plan</span> <span class="hljs-string">to</span> <span class="hljs-string">PR</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/github-script@v7</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">script:</span> <span class="hljs-string">|
            const output = `#### Terraform Plan - ${{ matrix.environment }} ğŸ“–
</span>            
            <span class="hljs-string">\`\`\`</span>
            <span class="hljs-string">${{</span> <span class="hljs-string">steps.plan.outputs.stdout</span> <span class="hljs-string">}}</span>
            <span class="hljs-string">\`\`\`</span>
            
            <span class="hljs-string">*Pushed</span> <span class="hljs-attr">by:</span> <span class="hljs-string">@${{</span> <span class="hljs-string">github.actor</span> <span class="hljs-string">}}*`;</span>
            
            <span class="hljs-string">github.rest.issues.createComment({</span>
              <span class="hljs-attr">issue_number:</span> <span class="hljs-string">context.issue.number,</span>
              <span class="hljs-attr">owner:</span> <span class="hljs-string">context.repo.owner,</span>
              <span class="hljs-attr">repo:</span> <span class="hljs-string">context.repo.repo,</span>
              <span class="hljs-attr">body:</span> <span class="hljs-string">output</span>
            <span class="hljs-string">})</span>
</div></code></pre>
<h4 id="968-%E9%83%A8%E7%BD%B2%E7%92%B0%E5%A2%83%E4%BF%9D%E8%AD%B7">9.6.8 éƒ¨ç½²ç’°å¢ƒä¿è­·</h4>
<p>åœ¨ GitHub Repository Settings ä¸­è¨­å®š Environmentï¼š</p>
<table>
<thead>
<tr>
<th>Environment</th>
<th>Protection Rules</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>dev</code></td>
<td>ç„¡ï¼ˆè‡ªå‹•éƒ¨ç½²ï¼‰</td>
</tr>
<tr>
<td><code>staging</code></td>
<td>Required reviewers: 1</td>
</tr>
<tr>
<td><code>production</code></td>
<td>Required reviewers: 2, Wait timer: 5 min</td>
</tr>
</tbody>
</table>
<h4 id="969-%E5%AE%8C%E6%95%B4%E9%83%A8%E7%BD%B2%E6%B5%81%E7%A8%8B">9.6.9 å®Œæ•´éƒ¨ç½²æµç¨‹</h4>
<pre><code class="language-mermaid"><div class="mermaid">sequenceDiagram
    participant Dev as Developer
    participant GH as GitHub
    participant GA as GitHub Actions
    participant GCP as GCP

    Dev->>GH: Push to feature branch
    GH->>GA: Trigger CI workflow
    GA->>GA: Run tests & lint
    GA->>GA: Build container (test)
    
    Dev->>GH: Create PR
    GH->>GA: Trigger terraform-plan
    GA->>GH: Post plan to PR comment
    
    Dev->>GH: Merge PR to main
    GH->>GA: Trigger deploy-dev
    GA->>GCP: Build & push container
    GA->>GCP: Terraform apply (dev)
    
    Dev->>GH: Manual trigger deploy-prod
    GH->>GA: Trigger deploy-prod
    GA->>GA: Terraform plan
    GA->>GH: Wait for approval
    GH->>GA: Approved
    GA->>GCP: Terraform apply (prod)
</div></code></pre>
<hr>
<h2 id="10-%E6%9C%AC%E5%9C%B0%E9%96%8B%E7%99%BC%E8%88%87%E6%B8%AC%E8%A9%A6%E7%AD%96%E7%95%A5">10. æœ¬åœ°é–‹ç™¼èˆ‡æ¸¬è©¦ç­–ç•¥</h2>
<p>æœ¬ç³»çµ±è¨­è¨ˆéœ€æ”¯æ´<strong>ç„¡é›²ç«¯ä¾è³´çš„æœ¬åœ°é–‹ç™¼</strong>ï¼Œä»¥åˆ©å¿«é€Ÿè¿­ä»£èˆ‡æ¸¬è©¦ã€‚</p>
<hr>
<h3 id="101-%E6%9C%AC%E5%9C%B0%E9%96%8B%E7%99%BC%E7%9B%AE%E6%A8%99">10.1 æœ¬åœ°é–‹ç™¼ç›®æ¨™</h3>
<ul>
<li>ä¸éœ€é€£ç·šçœŸå¯¦ GCP</li>
<li>ä¸éœ€å»ºç«‹çœŸå¯¦ Firestore</li>
<li>å¯ç”¨ curl / Postman ç›´æ¥æ¸¬ API</li>
<li>å¯æ¨¡æ“¬å¤šä½¿ç”¨è€…èˆ‡æ¬Šé™</li>
</ul>
<hr>
<h3 id="102-firestore-emulator-%E9%96%8B%E7%99%BC%E6%A8%A1%E5%BC%8F%E4%B8%BB%E8%A6%81%E6%8E%A8%E8%96%A6">10.2 Firestore Emulator é–‹ç™¼æ¨¡å¼ï¼ˆä¸»è¦æ¨è–¦ï¼‰</h3>
<h4 id="1021-%E5%B7%A5%E5%85%B7%E9%9C%80%E6%B1%82">10.2.1 å·¥å…·éœ€æ±‚</h4>
<ul>
<li>Node.js</li>
<li>Java Runtimeï¼ˆFirestore Emulator éœ€æ±‚ï¼‰</li>
<li>Firebase CLI</li>
</ul>
<h4 id="1022-%E5%95%9F%E5%8B%95-emulator">10.2.2 å•Ÿå‹• Emulator</h4>
<pre class="hljs"><code><div>npm install -g firebase-tools
firebase init emulators
firebase emulators:start --only firestore
</div></code></pre>
<p>Firestore Emulator é è¨­ä½ç½®ï¼š</p>
<ul>
<li>Host: <code>localhost</code></li>
<li>Port: <code>8080</code></li>
</ul>
<hr>
<h4 id="1023-api-%E6%9C%8D%E5%8B%99%E9%80%A3%E7%B7%9A-emulator">10.2.3 API æœå‹™é€£ç·š Emulator</h4>
<p>æœ¬åœ°å•Ÿå‹• API å‰éœ€è¨­å®šä»¥ä¸‹ç’°å¢ƒè®Šæ•¸ï¼š</p>
<pre class="hljs"><code><div><span class="hljs-built_in">export</span> GOOGLE_CLOUD_PROJECT=<span class="hljs-built_in">local</span>-dev
<span class="hljs-built_in">export</span> FIRESTORE_EMULATOR_HOST=localhost:8080
</div></code></pre>
<hr>
<h3 id="103-in-memory-repository-%E6%A8%A1%E5%BC%8F%E6%B8%AC%E8%A9%A6%E7%94%A8">10.3 In-Memory Repository æ¨¡å¼ï¼ˆæ¸¬è©¦ç”¨ï¼‰</h3>
<p>ç‚ºæå‡å–®å…ƒæ¸¬è©¦èˆ‡ CI ç©©å®šåº¦ï¼Œå¾Œç«¯éœ€å¯¦ä½œ Repository Patternï¼š</p>
<ul>
<li>IdentityLinkRepositoryï¼ˆèº«ä»½å°æ‡‰ï¼‰</li>
<li>UserRepository</li>
<li>BabyRepository</li>
<li>WeightRepository</li>
<li>MembershipRepository</li>
</ul>
<p>ä¾ç’°å¢ƒåˆ‡æ›å¯¦ä½œï¼š</p>
<ul>
<li>Local / Testï¼šInMemoryRepository</li>
<li>Productionï¼šFirestoreRepository</li>
</ul>
<hr>
<h3 id="104-%E6%9C%AC%E5%9C%B0%E8%AA%8D%E8%AD%89auth%E7%AD%96%E7%95%A5">10.4 æœ¬åœ°èªè­‰ï¼ˆAuthï¼‰ç­–ç•¥</h3>
<h4 id="1041-dev-auth-%E6%A8%A1%E5%BC%8F%E9%A0%90%E8%A8%AD">10.4.1 Dev Auth æ¨¡å¼ï¼ˆé è¨­ï¼‰</h4>
<ul>
<li>ä½¿ç”¨å›ºå®š Bearer Tokenï¼š<code>Authorization: Bearer dev</code></li>
<li>Server ç›´æ¥æ³¨å…¥ä½¿ç”¨è€…èº«åˆ†ï¼š
<ul>
<li>providerIss = <code>http://localhost</code></li>
<li>providerSub = <code>DEV_UID</code></li>
<li>internalUserId = <code>01DEV000000000000000000000</code></li>
</ul>
</li>
</ul>
<h4 id="1042-%E6%9C%AC%E5%9C%B0-auth-service%E9%80%B2%E9%9A%8E">10.4.2 æœ¬åœ° Auth Serviceï¼ˆé€²éšï¼‰</h4>
<p>å¯åœ¨æœ¬åœ°å•Ÿå‹•è‡ªå»º Auth Serviceï¼Œæ¨¡æ“¬å®Œæ•´ç™»å…¥æµç¨‹ï¼š</p>
<pre class="hljs"><code><div><span class="hljs-comment"># å•Ÿå‹•æœ¬åœ° Auth Service</span>
AUTH_PORT=8082 python -m auth.main

<span class="hljs-comment"># å•Ÿå‹• API Service æŒ‡å‘æœ¬åœ° Auth</span>
AUTH_ISSUER=http://localhost:8082 python -m api.main
</div></code></pre>
<p>æˆ–ä½¿ç”¨ uvicorn ç›´æ¥å•Ÿå‹•ï¼š</p>
<pre class="hljs"><code><div><span class="hljs-comment"># Auth Service</span>
<span class="hljs-built_in">cd</span> auth &amp;&amp; uvicorn main:app --port 8082 --reload

<span class="hljs-comment"># API Service</span>
<span class="hljs-built_in">cd</span> api &amp;&amp; AUTH_ISSUER=http://localhost:8082 uvicorn main:app --port 8081 --reload
</div></code></pre>
<ul>
<li>Client å¯æ¨¡æ“¬çœŸå¯¦ç™»å…¥æµç¨‹</li>
<li>API ç«¯é€é JWKS é©—è­‰ JWT</li>
</ul>
<hr>
<h3 id="105-auth-%E6%A8%A1%E5%BC%8F%E5%88%87%E6%8F%9B%E8%A8%AD%E8%A8%88">10.5 Auth æ¨¡å¼åˆ‡æ›è¨­è¨ˆ</h3>
<table>
<thead>
<tr>
<th>ç’°å¢ƒ</th>
<th>AUTH_MODE</th>
<th>èªè­‰æ–¹å¼</th>
</tr>
</thead>
<tbody>
<tr>
<td>Local Dev</td>
<td>dev</td>
<td>å›ºå®š dev token</td>
</tr>
<tr>
<td>Local Adv</td>
<td>local-oidc</td>
<td>æœ¬åœ° Auth Service JWT</td>
</tr>
<tr>
<td>Production</td>
<td>oidc</td>
<td>è‡ªå»º OIDC Auth Service JWT</td>
</tr>
<tr>
<td>Production (å‡ç´šå¾Œ)</td>
<td>keycloak / firebase</td>
<td>Keycloak / Firebase Auth JWT</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="106-%E6%9C%AC%E5%9C%B0-api-%E5%95%9F%E5%8B%95%E6%A8%99%E6%BA%96%E7%92%B0%E5%A2%83%E8%AE%8A%E6%95%B8">10.6 æœ¬åœ° API å•Ÿå‹•æ¨™æº–ç’°å¢ƒè®Šæ•¸</h3>
<pre class="hljs"><code><div>PORT=8081
GOOGLE_CLOUD_PROJECT=<span class="hljs-built_in">local</span>-dev
FIRESTORE_EMULATOR_HOST=localhost:8080
AUTH_MODE=dev
DEV_UID=dev-user
DEV_INTERNAL_USER_ID=01DEV000000000000000000000

<span class="hljs-comment"># é€²éšæ¨¡å¼ï¼ˆä½¿ç”¨æœ¬åœ° Auth Serviceï¼‰</span>
<span class="hljs-comment"># AUTH_MODE=local-oidc</span>
<span class="hljs-comment"># AUTH_ISSUER=http://localhost:8082</span>
<span class="hljs-comment"># AUTH_AUDIENCE=baby-weight-api</span>
</div></code></pre>
<hr>
<h3 id="107-%E6%9C%AC%E5%9C%B0%E8%B3%87%E6%96%99%E5%88%9D%E5%A7%8B%E5%8C%96%E5%BB%BA%E8%AD%B0">10.7 æœ¬åœ°è³‡æ–™åˆå§‹åŒ–å»ºè­°</h3>
<p>ç•¶ <code>AUTH_MODE=dev</code> æ™‚ï¼ŒAPI å•Ÿå‹•å¯è‡ªå‹•å»ºç«‹ï¼š</p>
<ul>
<li>identity_links/dev-link
<ul>
<li>providerIss: <code>http://localhost</code></li>
<li>providerSub: <code>dev-user</code></li>
<li>internalUserId: <code>01DEV000000000000000000000</code></li>
</ul>
</li>
<li>users/01DEV000000000000000000000</li>
<li>babies/demo-baby</li>
<li>babies/demo-baby/members/01DEV000000000000000000000 (role: owner)</li>
</ul>
<p>ä»¥åˆ© curl / Postman ç›´æ¥æ¸¬è©¦ã€‚</p>
<hr>
<h3 id="108-%E6%9C%AC%E5%9C%B0%E6%B8%AC%E8%A9%A6%E6%B5%81%E7%A8%8B%E7%AF%84%E4%BE%8B">10.8 æœ¬åœ°æ¸¬è©¦æµç¨‹ï¼ˆç¯„ä¾‹ï¼‰</h3>
<pre><code class="language-mermaid"><div class="mermaid">sequenceDiagram
    participant D as Developer
    participant API as Local API
    participant FS as Firestore Emulator

    D->>API: POST /v1/babies (Bearer dev)
    API->>FS: create baby
    D->>API: POST /v1/babies/{id}/weights
    API->>FS: write weight
    D->>API: GET /v1/babies/{id}/weights
    API->>FS: query weights
</div></code></pre>
<hr>
<h3 id="109-%E6%B8%AC%E8%A9%A6%E7%AD%96%E7%95%A5%E7%B8%BD%E8%A6%BD">10.9 æ¸¬è©¦ç­–ç•¥ç¸½è¦½</h3>
<p>æœ¬ç³»çµ±è¨­è¨ˆæ”¯æ´å¤šå±¤æ¬¡çš„æ¸¬è©¦ç­–ç•¥ï¼Œå¾å¿«é€Ÿæœ¬åœ°é–‹ç™¼åˆ°å®Œæ•´ E2E æ¸¬è©¦ï¼š</p>
<h4 id="1091-%E6%B8%AC%E8%A9%A6%E5%B1%A4%E6%AC%A1%E8%88%87-authgateway-%E9%85%8D%E7%BD%AE">10.9.1 æ¸¬è©¦å±¤æ¬¡èˆ‡ Auth/Gateway é…ç½®</h4>
<table>
<thead>
<tr>
<th>æ¸¬è©¦éšæ®µ</th>
<th>Auth æ¨¡å¼</th>
<th>API Gateway</th>
<th>ç”¨é€”</th>
</tr>
</thead>
<tbody>
<tr>
<td>å–®å…ƒæ¸¬è©¦</td>
<td>Mock</td>
<td>ç„¡</td>
<td>æ¸¬è©¦æ¥­å‹™é‚è¼¯</td>
</tr>
<tr>
<td>æœ¬åœ°é–‹ç™¼</td>
<td><code>dev</code></td>
<td>è·³é</td>
<td>å¿«é€Ÿè¿­ä»£</td>
</tr>
<tr>
<td>æœ¬åœ°æ•´åˆæ¸¬è©¦</td>
<td><code>local-oidc</code></td>
<td>è·³é</td>
<td>æ¸¬è©¦å®Œæ•´ Auth æµç¨‹</td>
</tr>
<tr>
<td>Dev ç’°å¢ƒæ¸¬è©¦</td>
<td><code>oidc</code></td>
<td>çœŸå¯¦ GCP</td>
<td>æ¸¬è©¦å®Œæ•´ Gateway + Auth</td>
</tr>
<tr>
<td>E2E / Staging</td>
<td><code>oidc</code></td>
<td>çœŸå¯¦ GCP</td>
<td>ä¸Šç·šå‰é©—è­‰</td>
</tr>
</tbody>
</table>
<h4 id="1092-%E7%B9%9E%E9%81%8E-auth-%E7%9A%84%E5%BF%AB%E9%80%9F%E6%B8%AC%E8%A9%A6">10.9.2 ç¹é Auth çš„å¿«é€Ÿæ¸¬è©¦</h4>
<p>ä½¿ç”¨ <code>AUTH_MODE=dev</code> é€²è¡Œå¿«é€Ÿé–‹ç™¼è¿­ä»£ï¼š</p>
<pre class="hljs"><code><div><span class="hljs-comment"># ç›´æ¥ç”¨å›ºå®š token æ¸¬è©¦</span>
curl -H <span class="hljs-string">"Authorization: Bearer dev"</span> \
     http://localhost:8081/v1/babies
</div></code></pre>
<p>Server æœƒè‡ªå‹•æ³¨å…¥å‡èº«ä»½ï¼Œç„¡éœ€çœŸå¯¦èªè­‰æµç¨‹ã€‚</p>
<h4 id="1093-%E4%B8%8D%E7%B9%9E%E9%81%8E-auth-%E7%9A%84%E6%95%B4%E5%90%88%E6%B8%AC%E8%A9%A6">10.9.3 ä¸ç¹é Auth çš„æ•´åˆæ¸¬è©¦</h4>
<p>ä½¿ç”¨ <code>AUTH_MODE=local-oidc</code> æ¸¬è©¦å®Œæ•´èªè­‰æµç¨‹ï¼š</p>
<pre class="hljs"><code><div><span class="hljs-comment"># Terminal 1: å•Ÿå‹•æœ¬åœ° Auth Service</span>
AUTH_PORT=8082 ./auth-service

<span class="hljs-comment"># Terminal 2: å•Ÿå‹• API Serviceï¼ˆæŒ‡å‘æœ¬åœ° Authï¼‰</span>
AUTH_MODE=<span class="hljs-built_in">local</span>-oidc \
AUTH_ISSUER=http://localhost:8082 \
AUTH_AUDIENCE=baby-weight-api \
./api-service
</div></code></pre>
<p>æ¸¬è©¦æµç¨‹ï¼š</p>
<pre class="hljs"><code><div><span class="hljs-comment"># 1. å…ˆç™»å…¥å–å¾— JWT</span>
TOKEN=$(curl -s -X POST http://localhost:8082/auth/token \
  -H <span class="hljs-string">"Content-Type: application/json"</span> \
  -d <span class="hljs-string">'{"email":"test@example.com","password":"testpass"}'</span> | jq -r .access_token)

<span class="hljs-comment"># 2. ç”¨çœŸå¯¦ JWT å‘¼å« API</span>
curl -H <span class="hljs-string">"Authorization: Bearer <span class="hljs-variable">$TOKEN</span>"</span> \
     http://localhost:8081/v1/babies
</div></code></pre>
<p>API Service æœƒé€é JWKS é©—è­‰ JWTï¼Œèˆ‡ Production è¡Œç‚ºä¸€è‡´ã€‚</p>
<h4 id="1094-api-gateway-%E6%B8%AC%E8%A9%A6%E7%AD%96%E7%95%A5">10.9.4 API Gateway æ¸¬è©¦ç­–ç•¥</h4>
<p><strong>GCP API Gateway æ²’æœ‰å®˜æ–¹æœ¬åœ°æ¨¡æ“¬å™¨</strong>ï¼Œæ¥­ç•Œå¸¸è¦‹åšæ³•ï¼š</p>
<table>
<thead>
<tr>
<th>æ–¹æ¡ˆ</th>
<th>èªªæ˜</th>
<th>å„ªé»</th>
<th>ç¼ºé»</th>
</tr>
</thead>
<tbody>
<tr>
<td>è·³é Gateway</td>
<td>æœ¬åœ°ç›´æ¥æ¸¬ API</td>
<td>ç°¡å–®å¿«é€Ÿ</td>
<td>ç„¡æ³•æ¸¬ Gateway è¡Œç‚º</td>
</tr>
<tr>
<td>æœ¬åœ°æ›¿ä»£ Gateway</td>
<td>ç”¨ Nginx/Kong æ¨¡æ“¬</td>
<td>å¯æ¸¬ routing</td>
<td>èˆ‡ GCP è¡Œç‚ºå¯èƒ½æœ‰å·®ç•°</td>
</tr>
<tr>
<td>ä½¿ç”¨ Dev ç’°å¢ƒ</td>
<td>éƒ¨ç½²åˆ° GCP dev æ¸¬è©¦</td>
<td>æ¸¬è©¦çœŸå¯¦è¡Œç‚º</td>
<td>è¿­ä»£é€Ÿåº¦è¼ƒæ…¢</td>
</tr>
</tbody>
</table>
<p><strong>å»ºè­°åšæ³•</strong>ï¼š</p>
<pre><code class="language-mermaid"><div class="mermaid">flowchart LR
    subgraph Local[æœ¬åœ°é–‹ç™¼]
        C1[Client] --> API1[API Service]
        API1 --> FS1[Firestore Emulator]
    end
    
    subgraph GCPDev[GCP Dev ç’°å¢ƒ]
        C2[Client] --> GW[API Gateway]
        GW --> API2[Cloud Run API]
        API2 --> FS2[Firestore]
    end
    
    Local -->|PR åˆä½µå¾Œ| GCPDev
</div></code></pre>
<ul>
<li><strong>æœ¬åœ°é–‹ç™¼</strong>ï¼šè·³é Gatewayï¼Œç›´æ¥æ¸¬ API</li>
<li><strong>PR åˆä½µå¾Œ</strong>ï¼šè‡ªå‹•éƒ¨ç½²åˆ° Dev ç’°å¢ƒï¼Œæ¸¬è©¦å®Œæ•´ Gateway æµç¨‹</li>
<li><strong>Release</strong>ï¼šéƒ¨ç½²åˆ° Staging/Prodï¼ŒåŸ·è¡Œ E2E æ¸¬è©¦</li>
</ul>
<h4 id="1095-%E6%9C%AC%E5%9C%B0%E6%9B%BF%E4%BB%A3-gateway%E5%8F%AF%E9%81%B8">10.9.5 æœ¬åœ°æ›¿ä»£ Gatewayï¼ˆå¯é¸ï¼‰</h4>
<p>å¦‚éœ€åœ¨æœ¬åœ°æ¨¡æ“¬ Gateway è¡Œç‚ºï¼Œå¯ä½¿ç”¨ Docker Compose + Nginxï¼š</p>
<pre class="hljs"><code><div><span class="hljs-comment"># docker-compose.yml</span>
<span class="hljs-attr">version:</span> <span class="hljs-string">'3.8'</span>
<span class="hljs-attr">services:</span>
  <span class="hljs-attr">gateway:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:alpine</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"8080:80"</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./nginx-local.conf:/etc/nginx/nginx.conf</span>
    <span class="hljs-attr">depends_on:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">api</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">auth</span>
  
  <span class="hljs-attr">auth:</span>
    <span class="hljs-attr">build:</span> <span class="hljs-string">./auth-service</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"8082:8082"</span>
  
  <span class="hljs-attr">api:</span>
    <span class="hljs-attr">build:</span> <span class="hljs-string">./api-service</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">AUTH_MODE=local-oidc</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">AUTH_ISSUER=http://auth:8082</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">FIRESTORE_EMULATOR_HOST=firestore:8080</span>
    <span class="hljs-attr">depends_on:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">firestore</span>
  
  <span class="hljs-attr">firestore:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">google/cloud-sdk:emulators</span>
    <span class="hljs-attr">command:</span> <span class="hljs-string">gcloud</span> <span class="hljs-string">emulators</span> <span class="hljs-string">firestore</span> <span class="hljs-string">start</span> <span class="hljs-string">--host-port=0.0.0.0:8080</span>
</div></code></pre>
<hr>
<h2 id="11-idp-%E5%8F%AF%E6%9B%BF%E6%8F%9B%E8%A8%AD%E8%A8%88">11. IdP å¯æ›¿æ›è¨­è¨ˆ</h2>
<p>æœ¬ç³»çµ±æ¡ç”¨ã€Œè‡ªå»ºæœ€å° OIDC Auth Serviceã€ä½œç‚ºåˆå§‹æ–¹æ¡ˆï¼Œä¸¦é ç•™æœªä¾†å‡ç´šè‡³ Keycloak æˆ– Firebase Auth çš„å½ˆæ€§ã€‚</p>
<h3 id="111-%E6%A0%B8%E5%BF%83%E7%9B%B8%E5%AE%B9%E6%80%A7%E8%A8%AD%E8%A8%88">11.1 æ ¸å¿ƒç›¸å®¹æ€§è¨­è¨ˆ</h3>
<p>ç‚ºç¢ºä¿æœªä¾†å¯ç„¡ç—›åˆ‡æ› IdPï¼Œç³»çµ±éµå¾ªä»¥ä¸‹è¨­è¨ˆåŸå‰‡ï¼š</p>
<table>
<thead>
<tr>
<th>è¨­è¨ˆè¦é»</th>
<th>èªªæ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>Bearer JWT èªè­‰</td>
<td>API æ°¸é åªæ¥å— <code>Authorization: Bearer &lt;token&gt;</code></td>
</tr>
<tr>
<td>æ¨™æº– JWT Claims</td>
<td>ä½¿ç”¨ <code>iss</code>ã€<code>aud</code>ã€<code>sub</code>ã€<code>exp</code>ã€<code>iat</code> ç­‰ OIDC æ¨™æº–æ¬„ä½</td>
</tr>
<tr>
<td>HTTPS Issuer</td>
<td><code>iss</code> å¿…é ˆæ˜¯ç©©å®šçš„ HTTPS URL</td>
</tr>
<tr>
<td>æ¨™æº– JWKS è·¯å¾‘</td>
<td>ä½¿ç”¨ <code>/.well-known/jwks.json</code></td>
</tr>
<tr>
<td>èº«ä»½åˆ†é›¢</td>
<td>å¤–éƒ¨èº«ä»½ï¼ˆiss+subï¼‰èˆ‡å…§éƒ¨èº«ä»½ï¼ˆinternalUserIdï¼‰åˆ†é›¢</td>
</tr>
<tr>
<td>æˆæ¬Šç¨ç«‹</td>
<td>æ¬Šé™è³‡æ–™å­˜æ”¾åœ¨ Firestoreï¼Œä¸ä¾è³´ IdP è§’è‰²</td>
</tr>
</tbody>
</table>
<h3 id="112-%E5%8D%87%E7%B4%9A%E8%B7%AF%E7%B7%9A-1%E8%87%AA%E5%BB%BA-auth-%E2%86%92-keycloak">11.2 å‡ç´šè·¯ç·š 1ï¼šè‡ªå»º Auth â†’ Keycloak</h3>
<pre><code class="language-mermaid"><div class="mermaid">flowchart LR
    subgraph Before[å‡ç´šå‰]
        C1[Client] --> A1[è‡ªå»º Auth]
        G1[Gateway] --> A1
    end
    
    subgraph After[å‡ç´šå¾Œ]
        C2[Client] --> A2[Keycloak]
        G2[Gateway] --> A2
    end
    
    Before --> |ä¿®æ”¹è¨­å®š| After
</div></code></pre>
<p><strong>å‡ç´šæ­¥é©Ÿ</strong>ï¼š</p>
<ol>
<li><strong>Client ç«¯</strong>ï¼šæ”¹ç‚ºå‘ Keycloak å–å¾— tokenï¼ˆæ”¯æ´ PKCEã€Refresh Tokenï¼‰</li>
<li><strong>API Gateway</strong>ï¼šä¿®æ”¹ <code>issuer</code> èˆ‡ <code>jwks_uri</code> æŒ‡å‘ Keycloak</li>
<li><strong>Cloud Run</strong>ï¼šå¹¾ä¹ä¸éœ€ä¿®æ”¹ï¼ˆä»é€é <code>identity_links</code> è§£æèº«ä»½ï¼‰</li>
<li><strong>è³‡æ–™å°é½Š</strong>ï¼š
<ul>
<li>ä½¿ç”¨è€…é¦–æ¬¡ç”¨ Keycloak ç™»å…¥æ™‚ï¼Œåœ¨ <code>identity_links</code> æ–°å¢ä¸€ç­†å°æ‡‰</li>
<li>ç¶å®šåˆ°åŸæœ‰çš„ <code>internalUserId</code></li>
</ul>
</li>
</ol>
<h3 id="113-%E5%8D%87%E7%B4%9A%E8%B7%AF%E7%B7%9A-2%E8%87%AA%E5%BB%BA-auth-%E2%86%92-firebase-auth">11.3 å‡ç´šè·¯ç·š 2ï¼šè‡ªå»º Auth â†’ Firebase Auth</h3>
<p><strong>å‡ç´šæ­¥é©Ÿ</strong>ï¼š</p>
<ol>
<li><strong>Client ç«¯</strong>ï¼šæ”¹ç‚ºä½¿ç”¨ Firebase Auth SDK å–å¾— ID Token</li>
<li><strong>API Gateway</strong>ï¼šä¿®æ”¹ <code>issuer</code> èˆ‡ <code>jwks_uri</code> æŒ‡å‘ Firebase</li>
<li><strong>Cloud Run</strong>ï¼šå¹¾ä¹ä¸éœ€ä¿®æ”¹</li>
<li><strong>è³‡æ–™å°é½Š</strong>ï¼šåŒä¸Š</li>
</ol>
<h3 id="114-%E8%BA%AB%E4%BB%BD%E7%B6%81%E5%AE%9A%E7%AD%96%E7%95%A5%E5%A4%9A-idp-%E5%85%B1%E5%AD%98">11.4 èº«ä»½ç¶å®šç­–ç•¥ï¼ˆå¤š IdP å…±å­˜ï¼‰</h3>
<p>ç•¶åˆ‡æ› IdP æ™‚ï¼Œæœ€å¤§çš„æŒ‘æˆ°æ˜¯ã€Œæ–°çš„ <code>sub</code> èˆ‡èˆŠè³‡æ–™å°ä¸ä¸Šã€ã€‚æœ¬ç³»çµ±é€é <code>identity_links</code> è§£æ±ºï¼š</p>
<pre class="hljs"><code><div># ä½¿ç”¨è€…åŸæœ¬ç”¨è‡ªå»º Auth ç™»å…¥
identity_links/link1
  - providerIss: &quot;https://auth.yourdomain.com&quot;
  - providerSub: &quot;user_01JHXYZ...&quot;
  - internalUserId: &quot;01JHXYZ123...&quot;

# åŒä¸€ä½¿ç”¨è€…æ”¹ç”¨ Keycloak ç™»å…¥å¾Œï¼Œæ–°å¢ä¸€ç­†å°æ‡‰
identity_links/link2
  - providerIss: &quot;https://keycloak.yourdomain.com/realms/baby&quot;
  - providerSub: &quot;f47ac10b-58cc-4372-a567-0e02b2c3d479&quot;
  - internalUserId: &quot;01JHXYZ123...&quot;  # æŒ‡å‘åŒä¸€å€‹å…§éƒ¨ ID
</div></code></pre>
<p><strong>ç¶å®šæµç¨‹</strong>ï¼š</p>
<ol>
<li>ä½¿ç”¨è€…ç”¨æ–° IdP ç™»å…¥</li>
<li>ç³»çµ±æª¢æŸ¥ <code>identity_links</code>ï¼Œæ‰¾ä¸åˆ°å°æ‡‰</li>
<li>æç¤ºä½¿ç”¨è€…é€²è¡Œå¸³è™Ÿç¶å®šï¼ˆä¾‹å¦‚ç”¨èˆŠå¸³è™Ÿé©—è­‰ä¸€æ¬¡ï¼‰</li>
<li>å»ºç«‹æ–°çš„ <code>identity_link</code>ï¼ŒæŒ‡å‘åŒä¸€å€‹ <code>internalUserId</code></li>
</ol>
<h3 id="115-%E5%8D%87%E7%B4%9A%E6%99%82%E7%9A%84%E5%85%83%E4%BB%B6%E5%BD%B1%E9%9F%BF">11.5 å‡ç´šæ™‚çš„å…ƒä»¶å½±éŸ¿</h3>
<table>
<thead>
<tr>
<th>å…ƒä»¶</th>
<th>å‡ç´šæ™‚éœ€ä¿®æ”¹</th>
<th>èªªæ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>Client</td>
<td>âš ï¸ éœ€ä¿®æ”¹</td>
<td>æ”¹è®Šå–å¾— token çš„æ–¹å¼</td>
</tr>
<tr>
<td>API Gateway</td>
<td>âš ï¸ éœ€ä¿®æ”¹</td>
<td>æ›´æ–° issuer / jwks_uri / audience</td>
</tr>
<tr>
<td>Cloud Run</td>
<td>âœ… å¹¾ä¹ä¸å‹•</td>
<td>åªéœ€ç¢ºä¿èƒ½è§£ææ–°çš„ iss+sub</td>
</tr>
<tr>
<td>Firestore è³‡æ–™</td>
<td>âœ… ä¸éœ€æ¬ç§»</td>
<td>é€é identity_links å°æ‡‰å³å¯</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="12-%E6%9C%AA%E4%BE%86%E6%93%B4%E5%85%85%E6%96%B9%E5%90%91">12. æœªä¾†æ“´å……æ–¹å‘</h2>
<ul>
<li>é«”é‡æˆé•·æ›²ç·šè¨ˆç®—</li>
<li>æ¨æ’­æé†’ï¼ˆCloud Scheduler + Pub/Subï¼‰</li>
<li>åŒ¯å‡º CSV / PDF</li>
<li>å¤šè£ç½®åŒæ­¥</li>
<li>å‡ç´šè‡³ Keycloak æˆ– Firebase Authï¼ˆæ”¯æ´ Refresh Tokenã€PKCEï¼‰</li>
</ul>
<hr>
<h2 id="13-%E9%99%84%E9%8C%84">13. é™„éŒ„</h2>
<ul>
<li>å¾Œç«¯èªè¨€ï¼šPython 3.12+</li>
<li>Web Frameworkï¼šFastAPIï¼ˆå»ºè­°ï¼‰</li>
<li>API æ¡ç”¨ REST + JSON</li>
<li>æ™‚é–“æ ¼å¼ï¼šISO 8601 (UTC)</li>
<li>é‡é‡å–®ä½ï¼šgramï¼ˆé¿å…æµ®é»èª¤å·®ï¼‰</li>
<li>å…§éƒ¨ ID æ ¼å¼ï¼šULIDï¼ˆ26 å­—å…ƒï¼Œæ™‚é–“å¯æ’åºï¼‰</li>
<li>åŸºç¤å»ºè¨­ç®¡ç†ï¼šTerraformï¼ˆ&gt;= 1.5ï¼‰</li>
<li>Terraform Providerï¼šhashicorp/googleï¼ˆ&gt;= 5.0ï¼‰</li>
<li>CI/CDï¼šGitHub Actions</li>
<li>GCP èªè­‰ï¼šWorkload Identity Federationï¼ˆç„¡ Service Account Keyï¼‰</li>
<li>Linter/Formatterï¼šRuff</li>
<li>Type Checkerï¼šMyPy</li>
<li>Test Frameworkï¼špytest</li>
</ul>
<hr>
<p><strong>End of Document</strong></p>

</body>
</html>
