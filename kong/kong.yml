# Kong Gateway 宣告式配置 (DB-less Mode)
# 文件：kong/kong.yml
# 用於本地開發和 Cloud Run 部署

_format_version: "3.0"
_transform: true

# ==============================================================================
# Services 定義
# ==============================================================================

services:
  # Auth Service - 公開端點
  - name: auth-service
    url: ${AUTH_SERVICE_URL:-http://auth:8082}
    routes:
      - name: auth-register
        paths:
          - /auth/register
        methods:
          - POST
        strip_path: false

      - name: auth-token
        paths:
          - /auth/token
        methods:
          - POST
        strip_path: false

      - name: jwks
        paths:
          - /.well-known/jwks.json
        methods:
          - GET
        strip_path: false

  # Weight API Service - 需要 JWT 認證
  - name: weight-api
    url: ${API_SERVICE_URL:-http://api:8081}
    routes:
      - name: api-babies
        paths:
          - /v1/babies
        strip_path: false

      - name: api-health
        paths:
          - /health
          - /ready
        methods:
          - GET
        strip_path: false

    # JWT 認證插件（僅套用到此 Service）
    plugins:
      - name: jwt
        config:
          key_claim_name: kid
          claims_to_verify:
            - exp
          # JWKS URI 會自動從 JWT header 的 kid 對應
          # 需要先用 Kong Admin API 註冊 consumer 和 jwt credential

# ==============================================================================
# 全域插件
# ==============================================================================

plugins:
  # CORS 處理
  - name: cors
    config:
      origins:
        - "*"
      methods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
      headers:
        - Authorization
        - Content-Type
        - Accept
      exposed_headers:
        - X-Request-Id
      credentials: true
      max_age: 3600

  # Rate Limiting（全域）
  - name: rate-limiting
    config:
      minute: 100
      hour: 1000
      policy: local
      fault_tolerant: true
      hide_client_headers: false

  # Request/Response 日誌
  - name: file-log
    config:
      path: /dev/stdout
      reopen: false

# ==============================================================================
# Consumers（JWT 認證用）
# ==============================================================================

consumers:
  - username: baby-weight-api
    jwt_secrets:
      - key: ${JWT_KEY_ID:-key-2026-01}
        algorithm: RS256
        # 注意：rsa_public_key 需要在部署時設定
        # 或透過 JWKS endpoint 動態驗證
