# Kong Gateway 宣告式配置 (DB-less Mode)
# 文件：kong/kong.yml
# 
# 注意：環境變數由 entrypoint.sh 在啟動時替換

_format_version: "3.0"
_transform: true

# ==============================================================================
# Consumers 定義（JWT 驗證用）
# ==============================================================================
consumers:
  - username: jwt-consumer-M_nEItc-U64
    jwt_secrets:
      - algorithm: RS256
        key: "M_nEItc-U64"
        rsa_public_key: |
          -----BEGIN PUBLIC KEY-----
          MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAprXn+OcyExxekafRCbvr
          FtvtrL3djC5Po17QfsNH9YDu4tY7Vgtv2n2LLL4sq0uCJ6i7P2Xnl+goZeB+OEM7
          xRRpqnEL5ZtvHrVDnuGqLMj0F7aQFcwrZQPTuMxz5HwMw1Nmt0752Re2P4k+u9V/
          P9T62WsG32/BY25V+sIoSdDsaNeukw0+ziu4/wPSVcWbyRQiasnzSu9q7gqDQS93
          o8/DV0zhchWUMPvdHJGL2gVtCFpQSoA9vATyep7kLBMFcJuo1UcaDHYfJjhqDIC6
          B2TSOKOLKRQ4BBZfD7TVevbCQLx+GSKildGZaldtqhu1HPdi9+IxGUZBcCfzAcme
          uwIDAQAB
          -----END PUBLIC KEY-----

# ==============================================================================
# Services 定義
# ==============================================================================

services:
  # Auth Service - 公開端點
  - name: auth-service
    url: AUTH_SERVICE_URL_PLACEHOLDER
    routes:
      - name: auth-register
        paths:
          - /auth/register
        methods:
          - POST
        strip_path: false

      - name: auth-token
        paths:
          - /auth/token
        methods:
          - POST
        strip_path: false

      - name: jwks
        paths:
          - /.well-known/jwks.json
        methods:
          - GET
        strip_path: false

  # Weight API Service
  - name: weight-api
    url: API_SERVICE_URL_PLACEHOLDER
    routes:
      - name: api-v1
        paths:
          - /v1/
        strip_path: false
        methods:
          - GET
          - POST
          - PUT
          - DELETE

      - name: api-health
        paths:
          - /health
          - /ready
        methods:
          - GET
        strip_path: false
    plugins:
      # Kong JWT 插件驗證用戶 JWT
      # consumers 和 jwt_secrets 會在啟動時從 JWKS 同步並添加到配置
      - name: jwt
        config:
          header_names:
            - Authorization
          uri_param_names:
            - token
          cookie_names:
            - jwt
          key_claim_name: kid  # 使用 kid 來匹配 JWT credential 的 key
          secret_is_base64: false
          run_on_preflight: true
          claims_to_verify:
            - exp
            - iss
            - aud

# ==============================================================================
# 全域插件
# ==============================================================================

plugins:
  # CORS 處理
  - name: cors
    config:
      origins:
        - "*"
      methods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
      headers:
        - Authorization
        - Content-Type
        - Accept
      exposed_headers:
        - X-Request-Id
      credentials: true
      max_age: 3600

  # Rate Limiting（全域）
  - name: rate-limiting
    config:
      minute: 100
      hour: 1000
      policy: local
      fault_tolerant: true
      hide_client_headers: false
