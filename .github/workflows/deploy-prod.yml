# Deploy to Prod - æ‰‹å‹•è§¸ç™¼éƒ¨ç½²
# éœ€è¦ approval æ‰èƒ½éƒ¨ç½²åˆ° Production

name: Deploy to Prod

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Image tag to deploy (e.g., 20260112143000-abc1234)"
        required: true
        type: string
      confirm:
        description: "Type 'deploy-prod' to confirm"
        required: true
        type: string

env:
  GCP_PROJECT_ID: "babyweightrecorder"
  GCP_REGION: "asia-east1"
  # Prod ç’°å¢ƒä½¿ç”¨ç¨ç«‹çš„ Artifact Registryï¼ˆç›®å‰å…ˆç”¨ dev çš„ï¼‰
  ARTIFACT_REGISTRY: "asia-east1-docker.pkg.dev/babyweightrecorder/baby-weight-dev"
  # TODO: Prod ç’°å¢ƒéœ€è¦è¨­å®šç¨ç«‹çš„ Workload Identity
  WORKLOAD_IDENTITY_PROVIDER: "projects/750410344862/locations/global/workloadIdentityPools/github-pool-dev/providers/github-provider"
  SERVICE_ACCOUNT: "github-actions-dev@babyweightrecorder.iam.gserviceaccount.com"

jobs:
  validate:
    name: Validate Inputs
    runs-on: ubuntu-latest
    steps:
      - name: Check confirmation
        if: ${{ github.event.inputs.confirm != 'deploy-prod' }}
        run: |
          echo "âŒ Deployment not confirmed. Please type 'deploy-prod' to confirm."
          exit 1

      - name: Validate image tag format
        run: |
          TAG="${{ github.event.inputs.image_tag }}"
          if [[ ! "$TAG" =~ ^[0-9]{14}-[a-f0-9]{7}$ ]] && [[ "$TAG" != "latest" ]]; then
            echo "âš ï¸ Warning: Image tag format looks unusual: $TAG"
            echo "Expected format: YYYYMMDDHHMMSS-sha1234 or 'latest'"
          fi
          echo "âœ… Image tag: $TAG"

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: validate
    permissions:
      contents: read
      id-token: write
    environment: production  # éœ€è¦åœ¨ GitHub è¨­å®š Environment protection rules

    strategy:
      matrix:
        include:
          - service: api
            cloud_run_service: weight-api-prod
          - service: auth
            cloud_run_service: auth-service-prod

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Verify image exists
        run: |
          IMAGE="${{ env.ARTIFACT_REGISTRY }}/${{ matrix.service }}:${{ github.event.inputs.image_tag }}"
          echo "Checking image: $IMAGE"
          gcloud artifacts docker images describe $IMAGE --format="value(image_summary.digest)" || {
            echo "âŒ Image not found: $IMAGE"
            exit 1
          }
          echo "âœ… Image verified"

      - name: Deploy to Cloud Run
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ matrix.cloud_run_service }}
          region: ${{ env.GCP_REGION }}
          image: ${{ env.ARTIFACT_REGISTRY }}/${{ matrix.service }}:${{ github.event.inputs.image_tag }}

      - name: Show deployment URL
        run: |
          echo "### ðŸš€ Deployed ${{ matrix.service }} to Production" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Service:** ${{ matrix.cloud_run_service }}" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** ${{ steps.deploy.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag:** ${{ github.event.inputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY

  notify:
    name: Deployment Notification
    runs-on: ubuntu-latest
    needs: deploy
    if: always()

    steps:
      - name: Summary
        run: |
          echo "### ðŸ“¦ Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ needs.deploy.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag:** ${{ github.event.inputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… All services deployed successfully!" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âŒ Deployment failed. Please check the logs." >> $GITHUB_STEP_SUMMARY
          fi
