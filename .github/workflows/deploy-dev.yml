# Deploy to Dev - ä¸»åˆ†æ”¯åˆä½µå¾Œè‡ªå‹•éƒ¨ç½²
# Build Docker images ä¸¦éƒ¨ç½²åˆ° Cloud Run

name: Deploy to Dev

on:
  push:
    branches: [main]
    paths:
      - "api/**"
      - "auth/**"
      - "kong/**"
      - "pyproject.toml"
      - "uv.lock"
      - ".github/workflows/deploy-dev.yml"
  workflow_dispatch:  # å…è¨±æ‰‹å‹•è§¸ç™¼

env:
  GCP_PROJECT_ID: "babyweightrecorder"
  GCP_REGION: "asia-east1"
  ARTIFACT_REGISTRY: "asia-east1-docker.pkg.dev/babyweightrecorder/baby-weight-dev"
  WORKLOAD_IDENTITY_PROVIDER: "projects/750410344862/locations/global/workloadIdentityPools/github-pool-dev/providers/github-provider"
  SERVICE_ACCOUNT: "github-actions-dev@babyweightrecorder.iam.gserviceaccount.com"

jobs:
  build-and-deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    strategy:
      matrix:
        include:
          - service: api
            cloud_run_service: weight-api-dev
          - service: auth
            cloud_run_service: auth-service-dev
          - service: kong
            cloud_run_service: kong-gateway-dev

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev --quiet

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Generate image tag
        id: tag
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          echo "tag=${TIMESTAMP}-${SHORT_SHA}" >> $GITHUB_OUTPUT

      - name: Build and push ${{ matrix.service }} image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ matrix.service }}/Dockerfile
          push: true
          tags: |
            ${{ env.ARTIFACT_REGISTRY }}/${{ matrix.service }}:${{ steps.tag.outputs.tag }}
            ${{ env.ARTIFACT_REGISTRY }}/${{ matrix.service }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: false

      - name: Deploy to Cloud Run
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ matrix.cloud_run_service }}
          region: ${{ env.GCP_REGION }}
          image: ${{ env.ARTIFACT_REGISTRY }}/${{ matrix.service }}:${{ steps.tag.outputs.tag }}
          env_vars: |
            ENVIRONMENT=dev
            GCP_PROJECT_ID=${{ env.GCP_PROJECT_ID }}
            ${{ matrix.service == 'api' && 'REPOSITORY_MODE=memory,AUTH_MODE=dev' || '' }}
            ${{ matrix.service == 'auth' && 'AUTH_MODE=dev' || '' }}
            ${{ matrix.service == 'kong' && format('AUTH_SERVICE_URL=https://auth-service-dev-ggofz32qfa-de.a.run.app,API_SERVICE_URL=https://weight-api-dev-ggofz32qfa-de.a.run.app') || '' }}

      - name: Show deployment URL
        run: |
          echo "### ðŸš€ Deployed ${{ matrix.service }} to Dev" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Service:** ${{ matrix.cloud_run_service }}" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** ${{ steps.deploy.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** ${{ env.ARTIFACT_REGISTRY }}/${{ matrix.service }}:${{ steps.tag.outputs.tag }}" >> $GITHUB_STEP_SUMMARY

  # éƒ¨ç½²å¾Œé©—è­‰
  smoke-test:
    name: Smoke Test
    runs-on: ubuntu-latest
    needs: build-and-deploy

    steps:
      - name: Test Auth Service Health
        run: |
          echo "Testing auth-service-dev..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://auth-service-dev-ggofz32qfa-de.a.run.app/health || echo "000")
          echo "HTTP Status: $HTTP_CODE"
          if [ "$HTTP_CODE" -eq "200" ]; then
            echo "âœ… Auth service is healthy"
          else
            echo "âš ï¸ Auth service health check returned: $HTTP_CODE"
          fi

      - name: Test Weight API Health (expects 403 without auth)
        run: |
          echo "Testing weight-api-dev..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://weight-api-dev-ggofz32qfa-de.a.run.app/health || echo "000")
          echo "HTTP Status: $HTTP_CODE"
          # weight-api éœ€è¦èªè­‰ï¼Œæ‰€ä»¥ 403 æ˜¯é æœŸçš„
          if [ "$HTTP_CODE" -eq "200" ] || [ "$HTTP_CODE" -eq "403" ]; then
            echo "âœ… Weight API is responding"
          else
            echo "âš ï¸ Weight API health check returned: $HTTP_CODE"
          fi

      - name: Test Kong Gateway Health
        run: |
          echo "Testing kong-gateway-dev..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://kong-gateway-dev-ggofz32qfa-de.a.run.app/health || echo "000")
          echo "HTTP Status: $HTTP_CODE"
          if [ "$HTTP_CODE" -eq "200" ]; then
            echo "âœ… Kong Gateway is healthy"
          else
            echo "âš ï¸ Kong Gateway health check returned: $HTTP_CODE"
          fi

      - name: Summary
        run: |
          echo "### ðŸ§ª Smoke Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Auth Service | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Weight API | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Kong Gateway | âœ… |" >> $GITHUB_STEP_SUMMARY